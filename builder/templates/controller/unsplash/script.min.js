jQuery(document).off("karma_finish_form_builder.getUnsplashPhoto").on("karma_finish_form_builder.getUnsplashPhoto",function(e,viewObject){var karmaUnsplash;karmaUnsplash=function(){this.APIURL="https://api.unsplash.com/";this.clientId="100034b1de5815805647bef611d9ed7575b6c1812daa39730488d32be4461e12";this.pageSurf=this.getPage();this.searchPageSurf=1;this.firstLoad=true;this.doingAjax=false;this.typingTimer;this.doneTypingInterval=2e3;this.oldValue="";this.detectScroll();this.openMediaLibrary();this.bindInputEvent()};karmaUnsplash.prototype.createUnsplashURL=function(type,queryParmas){var unsplashRequestURL=this.APIURL+type+"/"+"?client_id="+this.clientId;_.each(queryParmas,function(value,key){unsplashRequestURL+="&"+key+"="+value});return unsplashRequestURL};karmaUnsplash.prototype.bindInputEvent=function(){var that=this,searchInput=document.getElementById("karma-unsplash-search");searchInput.onkeyup=function(){clearTimeout(that.typingTimer);that.typingTimer=setTimeout(function(){that.searchAjax(that)},that.doneTypingInterval)};searchInput.onkeydown=function(){clearTimeout(that.typingTimer)}};karmaUnsplash.prototype.removeResults=function(){var element=document.querySelector(".karma-unsplash-images-result");if(null!=element){element.innerHTML=""}};karmaUnsplash.prototype.removeSearchMode=function(){var that=this,inputElement=document.getElementById("karma-unsplash-search");that.removeResults();that.loadImages(that.pageSurf,9,false);that.searchPageSurf=1;inputElement.parentNode.parentNode.classList.remove("karma-unsplash-search-mode")};karmaUnsplash.prototype.searchAjax=function(that){var inputElement=document.getElementById("karma-unsplash-search"),value=inputElement.value;if(""===value.trim()){that.removeSearchMode();return}if(1===that.searchPageSurf||that.oldValue!=value){that.removeResults()}that.oldValue=value;var queryParams={query:value,page:that.searchPageSurf,per_page:9},requestUrl=that.createUnsplashURL("search/photos",queryParams);inputElement.parentNode.parentNode.classList.add("karma-unsplash-search-mode");that.sendHTTPRequest(requestUrl)};karmaUnsplash.prototype.getPage=function(){return null!=localStorage.getItem("karmaUnsplashPage")?parseInt(localStorage.getItem("karmaUnsplashPage")):1};karmaUnsplash.prototype.loadImages=function(page,perPage,loadMore){var params={page:page,per_page:perPage};if(this.cacheTimeExpire()||true===loadMore){var requestURL=this.createUnsplashURL("photos",params);this.sendHTTPRequest(requestURL)}else{var images=localStorage.getItem("karmaUnsplashImages");this.showImages(JSON.parse(images),"thumb")}};karmaUnsplash.prototype.cacheTimeExpire=function(){var updateTime=localStorage.getItem("karmaUnsplashImagesTime");if(null===updateTime){return true}var currentTime=(new Date).getTime(),timeDiff=Math.abs(currentTime-parseInt(updateTime)),diffDays=Math.floor(timeDiff/(1e3*3600*24));if(diffDays>=1){localStorage.removeItem("karmaUnsplashImages");localStorage.removeItem("karmaUnsplashPage");return true}else{return false}};karmaUnsplash.prototype.storage=function(value){if(null!==localStorage.getItem("karmaUnsplashImages")){var storeData=localStorage.getItem("karmaUnsplashImages");storeData=JSON.parse(storeData);storeData=storeData.concat(value)}else{localStorage.setItem("karmaUnsplashImagesTime",(new Date).getTime());var storeData=value}localStorage.setItem("karmaUnsplashImages",JSON.stringify(storeData));localStorage.setItem("karmaUnsplashPage",this.pageSurf)};karmaUnsplash.prototype.showImages=function(images,size){var that=this,el=document.querySelector(".karma-unsplash-images-result");if(true===that.firstLoad){that.removeResults()}_.each(images,function(image){if(null!=el){el.appendChild(that.createChild(image,size))}});if(false===that.firstLoad){scrollToY(el.scrollTop+220,500,"easeInOutQuint")}that.firstLoad=false;that.pageSurf++};karmaUnsplash.prototype.detectScroll=function(){var scrollableElement=document.querySelector(".karma-unsplash-images-result"),that=this;scrollableElement.addEventListener("mousewheel",function(e){if(scrollableElement.scrollTop+scrollableElement.clientHeight>=scrollableElement.scrollHeight){e.preventDefault();if(false===that.doingAjax){if(scrollableElement.parentNode.classList.contains("karma-unsplash-search-mode")){that.searchAjax(that)}else{that.loadImages(that.pageSurf,9,true)}}}})};karmaUnsplash.prototype.createChild=function(img,size){var newChild=document.createElement("div");newChild.setAttribute("class","karma-unsplash-images-list");newChild.setAttribute("style","background-image:url("+img.urls[size]+")");newChild.onclick=function(){var selected=document.querySelector(".karma-unspalsh-selected");if(null!=selected){selected.classList.remove("karma-unspalsh-selected")}this.classList.add("karma-unspalsh-selected");document.querySelector(".karma-unsplash-image-input").value=img.urls.full};return newChild};karmaUnsplash.prototype.processResult=function(response){var images=JSON.parse(response),that=this;if("object"==typeof images.results){images=images.results;that.searchPageSurf++}else{that.storage(images)}that.showImages(images,"thumb");that.doingAjax=false};karmaUnsplash.prototype.sendHTTPRequest=function(URL){var XMLHttp=new XMLHttpRequest,that=this;that.doingAjax=true;XMLHttp.onreadystatechange=function(){if(XMLHttp.readyState==XMLHttpRequest.DONE){if(XMLHttp.status==200){that.processResult(XMLHttp.responseText)}else if(XMLHttp.status==400){throw"HTTP Error 400. The request hostname is invalid."}else{throw"Bad Request - Invalid URL"}}};XMLHttp.open("GET",URL,true);XMLHttp.send()};karmaUnsplash.prototype.callback=function(frame){var input=document.querySelector(".karma-unsplash-image-input");var attachment=frame.state().get("selection").first().toJSON();input.value=attachment.url};karmaUnsplash.prototype.openMediaLibrary=function(){var addImgLink=document.querySelector(".karma-unspalsh-media-library");viewObject.openMediaLibrary(addImgLink,this.callback)};if(null!==document.querySelector(".karma-unsplash-controller")){window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}();function scrollToY(scrollTargetY,speed,easing){var element=document.querySelector(".karma-unsplash-images-result"),scrollY=element.scrollTop,scrollTargetY=scrollTargetY||0,speed=speed||2e3,easing=easing||"easeOutSine",currentTime=0;var time=Math.max(.1,Math.min(Math.abs(scrollY-scrollTargetY)/speed,.8));var easingEquations={easeOutSine:function(pos){return Math.sin(pos*(Math.PI/2))},easeInOutSine:function(pos){return-.5*(Math.cos(Math.PI*pos)-1)},easeInOutQuint:function(pos){if((pos/=.5)<1){return.5*Math.pow(pos,5)}return.5*(Math.pow(pos-2,5)+2)}};function tick(){currentTime+=1/60;var p=currentTime/time;var t=easingEquations[easing](p);if(p<1){requestAnimFrame(tick);element.scrollTo(0,scrollY+(scrollTargetY-scrollY)*t)}else{element.scrollTo(0,scrollTargetY)}}tick()}var photos=new karmaUnsplash;photos.loadImages(photos.pageSurf,9,false);document.querySelector(".karma-unspalsh-icon").addEventListener("click",function(){var element=document.querySelector(".karma-unsplash-images-result");if(element.scrollTop+element.clientHeight>=element.scrollHeight){if(false===photos.doingAjax){if(element.parentNode.classList.contains("karma-unsplash-search-mode")){photos.searchAjax(photos)}else{photos.loadImages(photos.pageSurf,9,true)}}}scrollToY(element.scrollTop+220,500,"easeInOutQuint")},false)}});