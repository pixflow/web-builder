var karmaColorPicker=function(options){var $=jQuery;this.options={};this.defaultOptions={selector:".karma-color-picker",color:"#000000",opacity:false,multiColor:false,firstColorTitle:"Main",secondColorTitle:"Hover",presetColors:["#FFFFFF","#FEF445","#FAC711","#F24726","#E6E6E6","#CEE741","#8FD14F","#DA0263","#808080","#13CDD4","#0DA789","#652CB3","#141414","#2D9BF0","#404BB2"]};for(var i in this.defaultOptions){if(options.hasOwnProperty(i)){this.options[i]=options[i]}else{this.options[i]=this.defaultOptions[i]}}this.convertPresetColors();this.mainInput=document.querySelector(this.options.selector+" input.karma-colorpicker-main-color");this.hoverInput=document.querySelector(this.options.selector+" input.karma-colorpicker-second-color");if(this.mainInput==null||$(this.mainInput).hasClass("karma-color-picker-input")){return}this.mainInput.value=this.options.color;this.activeInput=this.mainInput;this.generateColorPickerID();this.init()};karmaColorPicker.prototype.generateColorPickerID=function(){var found=true;do{var uniqueID=(new Date).valueOf();if(document.querySelector(".color-picker-"+uniqueID)==null){found=false}}while(found);this.id=uniqueID};karmaColorPicker.prototype.convertPresetColors=function(){for(var i=0;this.options.presetColors.length>i;i++){this.options.presetColors[i]=this.hexToRgb(this.options.presetColors[i]).toLowerCase()}};karmaColorPicker.prototype.init=function(){var that=this;this.createColorPickerIcon();this.createColorPickerPopup();this.setInputsEvent();this.chooseColorEvent();this.changeColorAction();var handler=that.openColorPicker.bind(that);jQuery(document.querySelector(this.selector)).on("click.karma-color-picker",handler)};karmaColorPicker.prototype.createColorPickerIcon=function(){var that=this;var icon=document.createElement("div");icon.setAttribute("class","karma-color-picker-icon");icon.dataset.colorPickerId=this.id;this.icon=icon;this.mainInput.classList.add("karma-color-picker-input");if(null!=this.hoverInput){this.hoverInput.classList.add("karma-color-picker-input")}icon.style.background=this.mainInput.value;this.mainInput.parentElement.insertBefore(icon,this.mainInput);icon.addEventListener("click",function(e){e.preventDefault();e.stopPropagation();that.openColorPicker(e)},true)};karmaColorPicker.prototype.createNoColor=function(presetColors){var noColor=document.createElement("span");noColor.setAttribute("class","karma-color-picker-preset-color karma-no-color");noColor.setAttribute("data-color","rgba(0,0,0,0)");noColor.style.backgroundColor="rgba(0,0,0,0)";this.presetColorsEvent(noColor);presetColors.appendChild(noColor)};karmaColorPicker.prototype.createColorPickerPopup=function(){var that=this;var popup=document.createElement("div");popup.setAttribute("class","karma-color-picker-container");popup.dataset.colorPickerId=this.id;if(this.options.multiColor){var colorMode=document.createElement("div");colorMode.setAttribute("class","karma-color-picker-mode");var firstColor=document.createElement("span");firstColor.setAttribute("class","first-color active");firstColor.setAttribute("data-action","main");firstColor.innerText=this.options.firstColorTitle;colorMode.appendChild(firstColor);var secondColor=document.createElement("span");secondColor.setAttribute("class","second-color");secondColor.setAttribute("data-action","hover");secondColor.innerText=this.options.secondColorTitle;colorMode.appendChild(secondColor);popup.appendChild(colorMode)}var presetColors=document.createElement("div");presetColors.setAttribute("class","karma-color-picker-preset-colors");this.createNoColor(presetColors);for(var i=0;that.options.presetColors.length>i;i++){var presetColor=document.createElement("span");presetColor.setAttribute("class","karma-color-picker-preset-color");presetColor.setAttribute("data-color",that.hexToRgb(that.options.presetColors[i]).toLowerCase());presetColor.style.backgroundColor=that.options.presetColors[i];this.presetColorsEvent(presetColor);presetColors.appendChild(presetColor)}var chooseColor=document.createElement("span");chooseColor.setAttribute("class","karma-color-picker-preset-color karma-color-picker-choose-color");var chooseColorInput=document.createElement("input");chooseColorInput.setAttribute("id",that.id);chooseColorInput.setAttribute("class","karma-color-picker-input");chooseColor.appendChild(chooseColorInput);that.chooseColor=chooseColor;presetColors.appendChild(chooseColor);popup.addEventListener("click",function(e){e.stopPropagation()});popup.appendChild(presetColors);document.body.appendChild(popup);that.initSpectrumColorPicker()};karmaColorPicker.prototype.presetColorsEvent=function(el){var that=this;el.addEventListener("click",function(e){e.preventDefault();e.stopPropagation();if($(e.target).hasClass("selected")||$(e.target).hasClass("temp-pallet")){return false}else{$(e.target).siblings().removeClass("selected");e.target.className+=" selected";that.updateMainColor(e.target.style.backgroundColor)}},true)};karmaColorPicker.prototype.changeColorAction=function(){var that=this,$=jQuery;$('.karma-color-picker-container[data-color-picker-id="'+that.id+'"] .karma-color-picker-mode span').off("click.changeModes").on("click.changeModes",function(){$(this).siblings().removeClass("active");$(this).addClass("active");if($(this).attr("data-action")=="hover"){that.activeInput=that.hoverInput}else{that.activeInput=that.mainInput}$('.karma-color-picker-container[data-color-picker-id="'+that.id+'"] .selected').removeClass("selected");document.querySelector('.karma-color-picker-container[data-color-picker-id="'+that.id+'"] .karma-color-picker-preset-color[data-color="'+that.hexToRgb(that.activeInput.value)+'"]').classList.add("selected")})};karmaColorPicker.prototype.setInputsEvent=function(){var that=this,$=jQuery;$(this.mainInput).on("change",function(){that.icon.style.background=this.value});if(this.options.multiColor){$(this.hoverInput).on("change",function(){that.icon.style.background=this.value})}};karmaColorPicker.prototype.chooseColorEvent=function(){var that=this,$=jQuery;$(that.chooseColor).on("click",function(e){e.preventDefault();e.stopPropagation();var $spectrum=$("#"+that.id);$spectrum.spectrum("set",that.activeInput.value);$spectrum.spectrum("show");that.addColorToPallet(that.activeInput.value);return false})};karmaColorPicker.prototype.addColorToPallet=function(color,addClass){var presetColor=document.createElement("span");presetColor.setAttribute("class","karma-color-picker-preset-color user-pallet temp-pallet");presetColor.setAttribute("data-color",color.toLowerCase());if(true===addClass){presetColor.classList.remove("temp-pallet")}presetColor.style.backgroundColor=color;this.presetColorsEvent(presetColor);this.chooseColor.parentElement.insertBefore(presetColor,this.chooseColor)};karmaColorPicker.prototype.updateMainColor=function(newColor){var $=jQuery;$(this.activeInput).val(newColor).change().trigger("change/updateColor",[newColor,$(this.activeInput).hasClass("karma-colorpicker-second-color")]);$(this.activeInput).val(newColor).change();if($(this.activeInput).parents("#karma-element-setting-panel-container").length){$(this.activeInput).trigger("input")}};karmaColorPicker.prototype.saveColors=function(color){if("undefined"!==typeof Storage){var savedColors=null==localStorage.getItem("karmaColors")?[]:JSON.parse(localStorage.getItem("karmaColors"));if(true===savedColors.includes(color)||true===this.options.presetColors.includes(color)){return}if(8==savedColors.length){savedColors.shift()}savedColors.push(color);localStorage.setItem("karmaColors",JSON.stringify(savedColors))}};karmaColorPicker.prototype.onChangeColor=function(color){var that=this;if(null!=document.querySelector('.karma-color-picker-container[data-color-picker-id="'+that.id+'"] .temp-pallet')){$('.karma-color-picker-container[data-color-picker-id="'+that.id+'"] .selected').removeClass("selected");document.querySelector('.karma-color-picker-container[data-color-picker-id="'+that.id+'"] .temp-pallet').className+=" selected";$('.karma-color-picker-container[data-color-picker-id="'+that.id+'"] .temp-pallet').removeClass("temp-pallet")}var selectedPallet=document.querySelector('.karma-color-picker-container[data-color-picker-id="'+that.id+'"] .selected');selectedPallet.style.backgroundColor=color;selectedPallet.setAttribute("data-color",color);that.updateMainColor(color)};karmaColorPicker.prototype.initSpectrumColorPicker=function(){var that=this,$=jQuery;$("#"+this.id).spectrum({color:that.options.color,showAlpha:that.options.opacity,alphaVertical:true,preferredFormat:"hex",showInput:true,replacerClassName:"spectrum-color-preview",move:function(color){that.onChangeColor(color.toRgbString())},change:function(color){that.onChangeColor(color.toRgbString())},hide:function(color){that.saveColors(color.toRgbString())}});$(document).off("click.hideColorPickerContainer").on("click.hideColorPickerContainer",function(){$(".karma-color-picker-container").removeClass("karma-color-picker-opened");var $spectrum=$("#"+that.id);$spectrum.spectrum("show");$spectrum.spectrum("hide")});$(".karma-color-picker-container").off("click.hideColorPicker").on("click.hideColorPicker",function(e){e.stopPropagation();$(".temp-pallet").remove();var $spectrum=$("#"+that.id);$spectrum.spectrum("show");$spectrum.spectrum("hide")})};karmaColorPicker.prototype.openColorPicker=function(e){e.preventDefault();var colorPickerContainer=document.querySelector('.karma-color-picker-container[data-color-picker-id="'+e.target.dataset.colorPickerId+'"]'),that=this,$=jQuery;$(document).trigger("click.hideColorPickerContainer");if($(colorPickerContainer).hasClass("karma-color-picker-opened")){$(colorPickerContainer).removeClass("karma-color-picker-opened");var $spectrum=$("#"+that.id);$spectrum.spectrum("show");$spectrum.spectrum("hide")}else{if("undefined"!==typeof Storage){$(".karma-color-picker-preset-color.user-pallet").remove();var savedColors=null==localStorage.getItem("karmaColors")?[]:JSON.parse(localStorage.getItem("karmaColors"));_.each(savedColors,function(color){color=color.replace(/\s/g,"");if(!that.options.presetColors.includes(color)){that.addColorToPallet(color,true)}})}var icon=document.querySelector('.karma-color-picker-icon[data-color-picker-id="'+e.target.dataset.colorPickerId+'"]'),rect=icon.getBoundingClientRect(),scrollLeft=window.pageXOffset||document.documentElement.scrollLeft,scrollTop=window.pageYOffset||document.documentElement.scrollTop,topPosition=rect.top+scrollTop+icon.offsetHeight+20,leftPosition=rect.left+scrollLeft+icon.offsetWidth/2-76;colorPickerContainer.style.top=topPosition+"px";colorPickerContainer.style.left=leftPosition+"px";colorPickerContainer.className+=" karma-color-picker-opened";$(".karma-drop-down-box").removeClass("open-drop-down-gizmo");this.addCurrentColor(this.mainInput.value,"main");if(this.options.multiColor){this.addCurrentColor(this.hoverInput.value,"second")}if(this.options.multiColor){$('.karma-color-picker-container[data-color-picker-id="'+e.target.dataset.colorPickerId+'"] .karma-color-picker-mode .first-color').click()}}};karmaColorPicker.prototype.addCurrentColor=function(color,type){color=color.replace(/\s/g,"");if("rgba(0,0,0,0)"==color){return}if(this.activeInput.classList.contains("karma-colorpicker-main-color")){var active="main"}else{var active="second"}var currentColorRgb=this.hexToRgb(color).toLowerCase();var currentPallet=document.querySelector('.karma-color-picker-container[data-color-picker-id="'+this.id+'"] .karma-color-picker-preset-color[data-color="'+currentColorRgb+'"]');if(null!=currentPallet){currentPallet.classList.add("selected")}else{this.addColorToPallet(currentColorRgb,true);var currentPallet=document.querySelector('.karma-color-picker-container[data-color-picker-id="'+this.id+'"] .karma-color-picker-preset-color[data-color="'+currentColorRgb+'"]');if(type==active){currentPallet.classList.add("selected")}}};karmaColorPicker.prototype.hexToRgb=function(hex){hex=hex.replace(/\s/g,"");if("rgb"===hex.substr(0,3)){return hex}if(""===hex){return"rgb(0,0,0)"}var shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;hex=hex.replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b});var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?"rgb("+parseInt(result[1],16)+","+parseInt(result[2],16)+","+parseInt(result[3],16)+")":null};