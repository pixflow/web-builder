(function($,karmaBuilder){karmaBuilder.elementSettingPanel=Backbone.View.extend({events:{"click .delete-karma-element":"removeElement","click .karma-setting-panel-close-svg":"removeSettingPanel","input input:not(.no-trigger)":"updateModel","input textarea:not(.no-trigger)":"updateModel","change input[type=checkbox]":"updateModel"},initialize:function(){this.setElement($("body"))},render:function(){},bindDragEvents:function(){$("#karma-element-setting-panel-container").draggable({containment:"body",scroll:true,scrollSpeed:100,distance:10,drag:function(){$(this).css({width:"",height:""})},cancel:".karma-shortcode-setting-panel-extra, input"})},removeElement:function(){if(!confirm("are you sure?"))return;this.model.destroy();this.removeSettingPanel()},openSettingPanel:function(form){var html=document.createElement("div"),formHtml=this.formBuilder(form);if(null==formHtml){return}var elementAttributes=this.model.attributes,elementSelector=elementAttributes["shortcode_name"].replace("_","-")+"-"+elementAttributes.element_key;html.innerHTML=this.getWpTemplate("karma-element-setting-panel",{headerTitle:formHtml.title,content:formHtml.content,selector:elementSelector});document.body.appendChild(html);this.bindDragEvents();this.applyDependency();$(document).trigger("karma_finish_form_builder",[this])},updateElementParams:function(model,elementParam){for(var index in elementParam.params){var paramName=elementParam.params[index].name;if("gridlayout"===paramName){elementParam.params[index].value=this.currentGrid().length}if(undefined!==model.shortcode_attributes[paramName]){elementParam.params[index].value=model.shortcode_attributes[paramName]}}return elementParam},formBuilder:function(form){var shortcodeModel=this.model.attributes,shortcodeParams=this.getElementMap(shortcodeModel.shortcode_name,form);if(null==shortcodeParams){return}var popup=document.createElement("div"),settingPanelHeight=shortcodeParams.height;karmaformhtml='<form id="karma-Builder-form" style="height :'+settingPanelHeight+'px"  data-height ="'+settingPanelHeight+'"  autocomplete="off" onsubmit="return false">',formBuilderContents=this.formBuilderContentHtml(form);karmaformhtml+='<div id="elementRow" >'+formBuilderContents+"</div> </form>";popup.innerHTML=karmaformhtml;return{content:popup.innerHTML,title:shortcodeParams.title}},formBuilderContentHtml:function(form){var shortcodeModel=this.model.attributes,shortcodeParams=this.getElementMap(shortcodeModel.shortcode_name,form);shortcodeParams=this.updateElementParams(shortcodeModel,shortcodeParams);return this.formBuilderContentAction(shortcodeParams)},formBuilderContentAction:function(shortcodeParams){var groupHtml="",controllerSource,groupHtml_group=[];for(var counter in shortcodeParams.params){if(!shortcodeParams.params[counter].group&&"switch-panel"!=shortcodeParams.params[counter].type){controllerSource=this.getWpTemplate("karma-"+shortcodeParams.params[counter].type+"-controller",shortcodeParams.params[counter]);groupHtml+=this.setGeneralContainer(controllerSource,shortcodeParams.params[counter])}else if("switch-panel"===shortcodeParams.params[counter].type){if("undefined"!==typeof shortcodeParams.params[counter].form){shortcodeParams.params[counter]["view"]=this;shortcodeParams.params[counter]["formBuilder"]=true;controllerSource=this.getWpTemplate("karma-"+shortcodeParams.params[counter].type+"-controller",shortcodeParams.params[counter]);groupHtml+=this.setGeneralContainer(controllerSource,shortcodeParams.params[counter])}else{shortcodeParams.params[counter]["formBuilder"]=false;controllerSource=this.getWpTemplate("karma-"+shortcodeParams.params[counter].type+"-controller",shortcodeParams.params[counter]);groupHtml+=this.setGeneralContainer(controllerSource,shortcodeParams.params[counter])}}else{if(undefined===groupHtml_group[shortcodeParams.params[counter].group]){groupHtml_group[shortcodeParams.params[counter].group]={items:[],title:shortcodeParams.params[counter].group}}controllerSource=this.getWpTemplate("karma-"+shortcodeParams.params[counter].type+"-controller",shortcodeParams.params[counter]);var html=this.setGeneralContainer(controllerSource,shortcodeParams.params[counter]);groupHtml_group[shortcodeParams.params[counter].group]["items"].push(html)}var formBuilderGroupHtml=this.formBuilderGroupHtml(groupHtml_group)}var formBuilderContent=groupHtml+formBuilderGroupHtml;return formBuilderContent},formBuilderGroupHtml:function(htmlGroup){var settingPanelGroup="",controllerSource;for(var counter in htmlGroup){controllerSource=this.getWpTemplate("karma-setting-panel-groups-extend",htmlGroup[counter]);settingPanelGroup+=this.setGeneralContainer(controllerSource,htmlGroup[counter])}return settingPanelGroup},removeSettingPanel:function(){var settingPanel=document.querySelector("#karma-element-setting-panel-container");if(null!=settingPanel){settingPanel.parentNode.removeChild(settingPanel);elementSettingPanel.undelegateEvents();elementSettingPanel.$el.removeData().unbind();delete elementSettingPanel}},setGeneralContainer:function(source,dependencyParams){var classes="karma-controller-"+dependencyParams.name,newSource='<div class="karma-controller '+classes+'"';if("undefined"!=typeof dependencyParams.dependency){newSource+="data-dependency='"+JSON.stringify(dependencyParams.dependency)+"'";newSource+="data-dependency-element='"+dependencyParams.dependency.controller+"'"}newSource+=" >"+source+"</div>";return newSource},applyDependency:function(){var dependentElements=document.querySelectorAll(".karma-controller[data-dependency]"),that=this,dependecyInfo;_.each(dependentElements,function(dependentElement){dependecyInfo=JSON.parse(dependentElement.getAttribute("data-dependency")),dependentElementOBJ=document.querySelector('input[name="'+dependecyInfo.controller+'"]');that.applyDependencyOnLoad(dependentElement,dependecyInfo,dependentElementOBJ);dependentElementOBJ.addEventListener("change",function(){that.doDependency(dependentElement,dependecyInfo,this.value)})})},applyDependencyOnLoad:function(dependentElement,dependencyInfo,dependentElementOBJ){var dependentValue=dependentElementOBJ.value;this.doDependency(dependentElement,dependencyInfo,dependentValue)},doDependency:function(dependentElement,dependencyInfo,dependentValue){var isHide;if(dependencyInfo.value==dependentValue){dependentElement.classList.remove("karma-hide-controller");isHide=false}else{dependentElement.classList.add("karma-hide-controller");isHide=true}this.findDependentElements(dependentElement,isHide)},findDependentElements:function(dependentElement,isHide){var controller=dependentElement.querySelector("input").getAttribute("name"),dependentElements=document.querySelectorAll('[data-dependency-element="'+controller+'"]'),that=this,hide,lastElement;if(dependentElements.length){_.each(dependentElements,function(element){if(isHide||dependentElement.classList.contains("karma-hide-controller")){element.classList.add("karma-hide-controller")}else{element.classList.remove("karma-hide-controller");that.doDependency(element,JSON.parse(dependentElement.getAttribute("data-dependency")),dependentElement.querySelector("input").value)}lastElement=element});hide=lastElement.classList.contains("karma-hide-controller")?true:false;that.findDependentElements(lastElement,hide)}},updateModel:function(event){var attributes=JSON.parse(JSON.stringify(this.model.attributes.shortcode_attributes));attributes[event.target.name]=event.target.value;attributes.changed={};attributes.changed[event.target.name]=event.target.value;this.model.set("shortcode_attributes",attributes)},openMediaLibrary:function(addImgLink,callBack,multiple){var frame;addImgLink.addEventListener("click",function(){if(frame){frame.open();return}frame=wp.media({title:"Select or Upload Media Of Your Chosen Persuasion",button:{text:"Use this media"},multiple:multiple?multiple:false});frame.on("select",callBack.bind(frame,frame));frame.open()},false)}})})(jQuery,karmaBuilder);