(function($,karmaBuilder){karmaBuilder.elementSettingPanel=Backbone.View.extend({events:{"click .delete-karma-element":"removeElement","click .karma-setting-panel-close-svg":"removeSettingPanel","input input:not(.no-trigger)":"updateModel","input textarea:not(.no-trigger)":"updateModel","change input[type=checkbox]":"updateModel"},initialize:function(){this.setElement($("body"))},render:function(){},bindDragEvents:function(){$("#karma-element-setting-panel-container").draggable({containment:"body",scroll:true,scrollSpeed:100,distance:10,cancel:".karma-shortcode-setting-panel-extra, input"})},removeElement:function(){if(!confirm("are you sure?"))return;this.model.destroy();this.removeSettingPanel()},openSettingPanel:function(form){var template=wp.template("karma-element-setting-panel"),html=document.createElement("div"),content=this.formBuilder(form),elementAttributes=this.model.attributes,elementName=elementAttributes["shortcode_name"].replace("karma_",""),elementSelector=elementAttributes["shortcode_name"].replace("_","-")+"-"+elementAttributes.shortcode_attributes["element_key"];html.innerHTML=template({headerTitle:elementName+" Setting",content:content,selector:elementSelector});document.getElementById("page").appendChild(html);this.bindDragEvents();$(document).trigger("karma_finish_form_builder",[this])},updateElementParams:function(model,elementParam){console.log(elementParam);for(var index in elementParam.params){var paramName=elementParam.params[index].name;if("gridlayout"===paramName){elementParam.params[index].value=this.currentGrid().length}if(undefined!==model.shortcode_attributes[paramName]){elementParam.params[index].value=model.shortcode_attributes[paramName]}}return elementParam},formBuilder:function(form){var karmaformhtml='<form id="karma-Builder-form"  autocomplete="off" onsubmit="return false">',formBuilderContents=this.formBuilderContentHtml(form);karmaformhtml+='<div id="elementRow" >'+formBuilderContents+"</div> </form>";var popup=document.createElement("div");popup.innerHTML=karmaformhtml;return popup.innerHTML},formBuilderContentHtml:function(form){var shortcodeModel=this.model.attributes,groupHtml_group=[],groupHtml="",shortcodeParams=this.getElementMap(shortcodeModel.shortcode_name,form);shortcodeParams=this.updateElementParams(shortcodeModel,shortcodeParams);for(var counter in shortcodeParams.params){if(!shortcodeParams.params[counter].group){groupHtml+=this.getWpTemplate("karma-"+shortcodeParams.params[counter].type+"-controller",shortcodeParams.params[counter])}else{if(undefined===groupHtml_group[shortcodeParams.params[counter].group.text]){groupHtml_group[shortcodeParams.params[counter].group.text]={items:[],options:shortcodeParams.params[counter].group}}var html=this.getWpTemplate("karma-"+shortcodeParams.params[counter].type+"-controller",shortcodeParams.params[counter]);groupHtml_group[shortcodeParams.params[counter].group.text]["items"].push(html)}var formBuilderGroupHtml=this.formBuilderGroupHtml(groupHtml_group)}return groupHtml+formBuilderGroupHtml},formBuilderGroupHtml:function(groupHtml_group){var setting_panel_group="";for(var counter in groupHtml_group){setting_panel_group+=this.getWpTemplate("karma-"+groupHtml_group[counter].options.type+"-extend",groupHtml_group[counter])}return setting_panel_group},removeSettingPanel:function(){var settingPanel=document.querySelector("#karma-element-setting-panel-container");if(null!=settingPanel){settingPanel.parentNode.removeChild(settingPanel);elementSettingPanel.undelegateEvents();elementSettingPanel.$el.removeData().unbind();delete elementSettingPanel}},updateModel:function(event){var attributes=JSON.parse(JSON.stringify(this.model.attributes.shortcode_attributes));attributes[event.target.name]=event.target.value;attributes.changed={};attributes.changed[event.target.name]=event.target.value;this.model.set("shortcode_attributes",attributes)}})})(jQuery,karmaBuilder);