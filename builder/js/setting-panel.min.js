(function($,karmaBuilder){karmaBuilder.elementSettingPanel=Backbone.View.extend({events:{"click .delete-karma-element":"removeElement","click .karma-setting-panel-close-svg":"removeSettingPanel","input input:not(.no-trigger)":"updateModel","input textarea:not(.no-trigger)":"updateModel","change input[type=checkbox]":"updateModel"},initialize:function(){this.setElement($("body"))},render:function(){},bindDragEvents:function(){$("#karma-element-setting-panel-container").draggable({containment:"body",scroll:true,scrollSpeed:100,distance:10,cancel:".karma-shortcode-setting-panel-extra, input"})},removeElement:function(){if(!confirm("are you sure?"))return;this.model.destroy();this.removeSettingPanel()},openSettingPanel:function(model,form){var template=wp.template("karma-element-setting-panel"),html=document.createElement("div"),content=this.formBuilder(model,form),elementAttributes=model.attributes,elementName=elementAttributes["shortcode_name"].replace("karma_",""),elementSelector=elementAttributes["shortcode_name"].replace("_","-")+"-"+elementAttributes.shortcode_attributes["element_key"];html.innerHTML=template({headerTitle:elementName+" Setting",content:content,selector:elementSelector});document.getElementById("page").appendChild(html);this.bindDragEvents();$(document).trigger("karma_finish_form_builder",[this])},updateElementParams:function(model,elementParam){for(var index in elementParam.params){var paramName=elementParam.params[index].name;if("gridlayout"===paramName){elementParam.params[index].value=this.currentGrid().length}if(undefined!==model.shortcode_attributes[paramName]){elementParam.params[index].value=model.shortcode_attributes[paramName]}}return elementParam},formBuilder:function(model,form){var shortcodeModel=model.attributes,shortcodeParams=this.getElementMap(shortcodeModel.shortcode_name,form),karmaformhtml='<form id="karma-Builder-form"  autocomplete="off" onsubmit="return false">',groupHtml="",groupHtml_group=[],setting_panel_group="";shortcodeParams=this.updateElementParams(shortcodeModel,shortcodeParams);for(var counter in shortcodeParams.params){if(!shortcodeParams.params[counter].group){groupHtml+=this.getWpTemplate("karma-"+shortcodeParams.params[counter].type+"-controller",shortcodeParams.params[counter])}else{if(undefined===groupHtml_group[shortcodeParams.params[counter].group]){groupHtml_group[shortcodeParams.params[counter].group]={items:[],title:shortcodeParams.params[counter].group}}var html=this.getWpTemplate("karma-"+shortcodeParams.params[counter].type+"-controller",shortcodeParams.params[counter]);groupHtml_group[shortcodeParams.params[counter].group]["items"].push(html)}}for(var counter in groupHtml_group){setting_panel_group+=this.getWpTemplate("karma-setting-panel-groups-extend",groupHtml_group[counter])}karmaformhtml+='<div id="elementRow" >'+groupHtml+"</div>";var popup=document.createElement("div");popup.innerHTML=karmaformhtml+setting_panel_group;return popup.innerHTML},removeSettingPanel:function(){var settingPanel=document.querySelector("#karma-element-setting-panel-container");settingPanel.parentNode.removeChild(settingPanel);this.undelegateEvents();this.$el.removeData().unbind()},updateModel:function(event){var attributes=JSON.parse(JSON.stringify(this.model.attributes.shortcode_attributes));attributes[event.target.name]=event.target.value;attributes.changed={};attributes.changed[event.target.name]=event.target.value;this.model.set("shortcode_attributes",attributes)}})})(jQuery,karmaBuilder);