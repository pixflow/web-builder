(function($,karmaBuilder){karmaBuilder.shortcodes=karmaBuilder.elementSettingPanel.extend({events:{"mousedown > .karma-spacing-container .karma-spacing-dot-container":"showMouseToolTip","before/buildGizmo":"gimzoAction",click:"showElementGizmo","click .karma-align-center":"karmaTextShortcodealignCenter","click .karma-align-left":"karmaTextShortcodealignLeft","click .karma-align-right":"karmaTextShortcodealignRight","click .karma-more-setting":"showGizmoRelatedToMore","click .karma-drop-down-icon":"openDropDownGzmo","click .karma-set-bold-style":"setBoldStyle","click .karma-set-italic-style":"setItalicStyle","click .karma-set-underline-style":"setUnderlineStyle"},documentEvents:{colorPickerRender:"colorPicker"},gizmoTriggers:[],shortcodeParams:{},gizmos:{},innerGizmoTemplate:'<div class=" karma-gizmo-template karma-inner-gizmo-template {{ data.className }}">'+" <# _.each( data.params, function( param ){ #>"+' <div class="karma-builder-gizmo-{{ param.type }} {{ param.className }} " data-form="{{ param.form }}">'+'<# print( KarmaView.getUnderscoreTemplate( karmaBuilder.shortcodes.prototype[ param.type + "Template" ] , param.params ) ) #>'+"</div>"+"<# }) #>"+"</div>",outerGizmoTemplate:'<div class="karma-gizmo-template karma-outer-gizmo-template {{ data.className }}">'+" <# _.each( data.params, function( param ){ #>"+' <div class="karma-builder-gizmo-{{ param.type }} {{ param.className }} " data-form="{{ param.form }}">'+'<# print( KarmaView.getUnderscoreTemplate( karmaBuilder.shortcodes.prototype[ param.type + "Template" ] , param.params ) ) #>'+"</div>"+"<# }) #>"+"</div>",simpleTextTemplate:" <div> {{ data.value }} </div> ",simpleIconTemplate:" <div> {{{ data.icon }}} </div> ",colorPickerTemplate:'<input class="karma-color-gizmo" id="{{{ data.id }}}"/>'+'<# karmaBuilder.shortcodes.prototype.gizmoTriggers.push({ event: "colorPickerRender", data: data }); #>',alignmentGizmoTemplate:' <button class="karma-drop-down-icon karma-alignment-drop-down-gizmo"> {{{ data.defaultIcon }}} </button> '+'<div class="karma-drop-down-box karma-alignment-drop-down">'+'<button class="karma-align-left" data-value="align-left" >'+"{{{data.leftAlignIcon}}}"+"</button>"+'<button class="karma-align-right" data-value="align-right" >'+"{{{data.rightAlignIcon}}}"+"</button>"+'<button class="karma-align-center" data-value="align-center" >'+"{{{data.centerAlignIcon}}}"+"</button>"+"</div>",bothSpacingGizmoTemplate:'<div class="{{ data.className }} karma-spacing-container">'+'<div class="karma-spacing karma-top-spacing  " data-direction="both" >'+'<div class="karma-spacing-dot-container ui-resizable-handle ui-resizable-s karma-top-spacing-height">'+'<div class="spacing-dot"></div>'+'<div class="spacing-top-hover"><div class="spacing-dot-hover target-moving"></div></div>'+"</div>"+"</div>"+'<div class="karma-spacing karma-bottom-spacing " data-direction="both" style="height:{{ data.space }}px">'+'<div class="karma-spacing-dot-container ui-resizable-handle  ui-resizable-s">'+'<div class="spacing-dot"></div>'+'<div class="spacing-bottom-hover"><div class="spacing-dot-hover"></div></div>'+"</div>"+"</div>"+"</div>",leftSpacingGizmoTemplate:'<div class="left-resizing {{ data.className }} karma-spacing-container">'+'<div class="karma-spacing karma-left-spacing " data-direction="left" style="width:{{ data.leftspace}}px">'+'<div class="karma-spacing-dot-container ui-resizable-handle ui-resizable-e">'+'<div class="spacing-dot"></div>'+'<div class="spacing-left-hover"><div class="spacing-dot-hover target-moving"></div></div>'+"</div>"+"</div>"+"</div>",rightSpacingGizmoTemplate:'<div class="{{ data.className }} karma-spacing-container">'+'<div class="karma-spacing karma-right-spacing" data-direction="right" style="width:{{ data.rightspace }}px">'+'<div class="karma-spacing-dot-container  ui-resizable-handle ui-resizable-w ">'+'<div class="spacing-dot"></div>'+'<div class="spacing-right-hover"><div class="spacing-dot-hover target-moving"></div></div>'+"</div>"+"</div>"+"</div>",topSpacingGizmoTemplate:'<div class="{{ data.className }} karma-spacing-container">'+'<div class="karma-spacing karma-top-spacing ui-resizable-handle ui-resizable-s ui-resizable-n " data-direction="top" style="height:{{ data.spaceing }}px">'+'<div class="karma-spacing-dot-container">'+'<div class="spacing-dot"></div>'+'<div class="spacing-dot-hover target-moving"></div>'+"</div>"+"</div>"+"</div>",resizeGizmoTemplate:'<div class="{{data.class}}" data-snap="{{data.param.snapGrid}}" ></div>',topGizmoTemplate:'<div class="{{data.class}}">'+" <# _.each( data.params, function( param ){  #>"+' <div class="karma-builder-gizmo-{{ param.type }} {{ param.className }} " data-form="{{ param.form }}">'+' <# if( "icon" === param.type ){ #>'+" <div>{{{ param.icon }}}</div>"+'<# } else if( "text" === param.type ) {#>'+"<div>{{{ param.value }}}</div>"+'<# } else if( "icon-text" === param.type ) {#>'+'<span class="karama-gizmo-icon">{{{ param.icon }}}</span>'+'<span class="karma-gizmo-title">{{{ param.text }}} {{param.counter}}</span>'+"<# } #>"+"</div>"+"<# }) #>"+"</div>",placeholderTemplate:'<div class="karma-element-placeholder {{ data.className }}" >'+'<div class="karma-inner-placeholder" >'+"</div>"+"</div>",alignmentGizmoTemplate:' <button class="karma-drop-down-icon karma-alignment-drop-down-gizmo"> {{{ data.defaultIcon }}} </button> '+'<div class="karma-drop-down-box karma-alignment-drop-down">'+'<button class="karma-align-left" data-value="align-left" >'+"{{{data.leftAlignIcon}}}"+"</button>"+'<button class="karma-align-right" data-value="align-right" >'+"{{{data.rightAlignIcon}}}"+"</button>"+'<button class="karma-align-center" data-value="align-center" >'+"{{{data.centerAlignIcon}}}"+"</button>"+"</div>",fontStyleGizmoTemplate:' <button class="karma-drop-down-icon  karma-font-style-drop-down-gizmo"> {{{ data.defaultIcon }}} </button> '+'<div class="karma-drop-down-box karma-font-style-drop-down">'+'<button class="karma-set-bold-style" >'+"{{{ data.bold }}}"+"</button>"+'<button class="karma-set-italic-style" >'+"{{{ data.italic }}}"+"</button>"+'<button class="karma-set-underline-style" >'+"{{{ data.underline }}}"+"</button>"+"</div>",initialize:function(options){this.template=options.template;if(this.model){_.bindAll(this,"update","destroy");this.model.bind("change",this.update);this.model.bind("destroy",this.destroy)}this.delegateEventsOnDocument();this.gizmoParams=options.gizmoParams;this.toolTipHtml();this.removeGizmo();this.karmaLinksDocumentClick();this.removeMoreSubmenu()},delegateEventsOnDocument:function(){for(var i in this.documentEvents){$(document).off(i).on(i,this[this.documentEvents[i]])}},karmaTextShortcodealignLeft:function(){document.execCommand("justifyLeft",true)},karmaTextShortcodealignCenter:function(){document.execCommand("justifyCenter",true)},karmaTextShortcodealignRight:function(){document.execCommand("justifyRight",true)},karmaLinksDocumentClick:function(){this.$el.find('.karma-document-click[href*="javascript:"]').off("click.documentClick").on("click.documentClick",function(){$(document).trigger("click")})},setItalicStyle:function(){document.execCommand("italic",true)},setUnderlineStyle:function(){document.execCommand("underline",true)},setBoldStyle:function(){document.execCommand("bold",true)},renderSettings:function(){this.createPlaceHolders();this.createGizmo();this.delegateEvents()},createPlaceHolders:function(){var getName=this.model.get("shortcode_name"),placeholderHTML;if("karma_column"!=getName&&"karma_section"!=getName){placeholderHTML=KarmaView.getUnderscoreTemplate(this.placeholderTemplate,{className:"karma-insert-between-elements-placeholder"});this.el.insertAdjacentHTML("afterend",placeholderHTML);if(1==this.model.get("order")){this.el.insertAdjacentHTML("beforebegin",placeholderHTML)}}else if("karma_column"==getName&&0==karmaBuilder.karmaModels.where({parent_key:this.model.get("element_key")}).length){placeholderHTML=KarmaView.getUnderscoreTemplate(this.placeholderTemplate,{className:"karma-column-placeholder"});this.el.querySelector(".karma-column").innerHTML=placeholderHTML}},gizmoEvents:function(gizmoParams){if("undefined"===typeof gizmoParams){return}for(var i in gizmoParams){if("undefined"!==typeof gizmoParams[i].form){var event={};event["click ."+gizmoParams[i].className]="showSettingPanel";this.delegateEvents(_.extend(this.events,event))}}},getElementMap:function(elementName,form){if(this.shortcodeParams){this.shortcodeParams=JSON.parse(builderMaps)}return this.shortcodeParams[elementName][form]},gizmoBuilder:function(gizmoParams){var tempName=gizmoParams.type+"Template",that=this;if("undefined"!==typeof this[tempName]){gizmoParams=that.$el.triggerHandler("before/buildGizmo",[tempName,gizmoParams]);return $(KarmaView.getUnderscoreTemplate(that[tempName],gizmoParams,that))}},createGizmo:function(){for(var i in this.gizmoParams){for(var param in this.gizmoParams[i].params){if(this.gizmoParams[i].params[param].hasOwnProperty("showIndex")){this.gizmoParams[i].params[param]["counter"]=this.$el.parent().find('> div[class *= "col-sm"]').index(this.$el)+1}else{this.gizmoParams[i].params[param]["counter"]=""}}var $gizmo=this.gizmoBuilder(this.gizmoParams[i]);for(var j in this.gizmoTriggers){$(document).trigger(this.gizmoTriggers[j].event,[this.gizmoTriggers[j].data])}this.gizmoTriggers=[];this.$el.append($gizmo);if("function"===typeof this[this.gizmoParams[i].type.replace(/-/g,"")]){this[this.gizmoParams[i].type.replace(/-/g,"")]($gizmo)}this.gizmoEvents(this.gizmoParams[i].params)}},bothSpacingGizmo:function($gizmo){var that=this,options={maxHeight:700,minHeight:0,handles:{},scroll:true,stop:function(event,ui){that.setAttributes({space:parseInt(ui.element.height())},true)},resize:function(event,ui){that.renderCss("."+that.elementSelector(),"padding-top",ui.size.height+"px");that.renderCss("."+that.elementSelector(),"padding-bottom",ui.size.height+"px")}};options.handles.s=$gizmo.find(".ui-resizable-s").eq(0);options.handles.n=$gizmo.find(".ui-resizable-s").eq(1);this.$el.find(".karma-bottom-spacing").resizable(options)},colorPicker:function(e,data){var that=this,options={selector:"#"+data.id,multiColor:true,firstColorTitle:"Main",secondColorTitle:"Hover",presetColors:["#FFFFFF","#FEF445","#FAC711","#F24726","#E6E6E6","#CEE741","#8FD14F","#DA0263","#808080","#13CDD4","#0DA789","#652CB3","#141414","#2D9BF0","#404BB2"]};new karmaColorPicker(options)},topSpacingGizmo:function($gizmo){var that=this,options={maxHeight:700,minHeight:0,handles:{},stop:function(event,ui){that.setAttributes({space:parseInt(ui.element.height())},true)},resize:function(event,ui){var currentSection=that.el.querySelector("div:first-child");currentSection.style.paddingTop=ui.size.height+"px"}};options.handles.s=$gizmo.find(".ui-resizable-s");this.$el.find(".karma-top-spacing").resizable(options)},createRightLeftSpacingGizmo:function(spacingSelector,paddingDirection){var calculating=this.calculateMaxWidthSpacing(spacingSelector),maxWidth=calculating,that=this,options={maxWidth:maxWidth,minWidth:0,handles:{},stop:function(event,ui){var value=parseInt(ui.element.width())<0?0:parseInt(ui.element.width());if("padding-left"==paddingDirection){that.setAttributes({leftspace:value},true)}else{that.setAttributes({rightspace:value},true)}},resize:function(event,ui){var calculating=that.calculateMaxWidthSpacing(spacingSelector);ui.element.resizable("option","maxWidth",calculating);var value=ui.size.width<0?0:parseInt(ui.size.width);that.renderCss(".karma-no-gutters > .karma-builder-element > .karma-column."+that.elementSelector(),paddingDirection,value+"px")}};return options},leftSpacingGizmo:function($gizmo){var that=this;var options=this.createRightLeftSpacingGizmo(".karma-right-spacing","padding-left");that.$el.attr("data-direction","left");options.handles.e=$gizmo.find(".ui-resizable-e");this.$el.find(".karma-left-spacing").resizable(options)},rightSpacingGizmo:function($gizmo){var that=this;var options=this.createRightLeftSpacingGizmo(".karma-left-spacing","padding-right");that.$el.attr("data-direction","left");options.handles.w=$gizmo.find(".ui-resizable-w");this.$el.find(".karma-right-spacing").resizable(options)},calculateMaxWidthSpacing:function(spacingGizmo){var $element=this.$el,elementWidth=$element.width(),elementSpacing=$element.find(spacingGizmo).width(),paddingValue=elementWidth-elementSpacing-10;return paddingValue},showMouseToolTip:function(e){var that=this;var tooltipDiv=document.body.querySelector(".tooltip-div");tooltipDiv.style.display="block";tooltipDiv.style.top=e.clientY+20+"px";tooltipDiv.style.left=e.clientX-20+"px";tooltipDiv.innerText="";e.target.classList.add("target-moving");var direction=$(e.target).closest(".karma-spacing").attr("data-direction");this.showMouseToolTipValue(tooltipDiv,direction);document.documentElement.addEventListener("mousemove",function(e){that.moveMouseToolTip(e,that,direction)},false);document.documentElement.addEventListener("mouseup",this.removeMouseToolTip,false)},moveMouseToolTip:function(e,that,direction){var tooltipDiv=document.body.querySelector(".tooltip-div");if("none"===tooltipDiv.style.display){return false}var x=e.clientX,y=e.clientY;tooltipDiv.style.top=y+20+"px";tooltipDiv.style.left=x-20+"px";that.showMouseToolTipValue(tooltipDiv,direction)},showMouseToolTipValue:function(tooltipDiv,direction){switch(direction){case"left":tooltipDiv.innerText=this.$el.find("> .karma-spacing-container .karma-spacing.karma-left-spacing").width()+" px";break;case"right":tooltipDiv.innerText=this.$el.find("> .karma-spacing-container .karma-spacing.karma-right-spacing").width()+" px";break;case"both":tooltipDiv.innerText=this.$el.find("> .karma-spacing-container .karma-spacing.karma-bottom-spacing").height()+" px";break;case"top":tooltipDiv.innerText=this.$el.find("> .karma-spacing-container .karma-spacing").height()+" px";break}},removeMouseToolTip:function(e){var tooltipDiv=document.body.querySelector(".tooltip-div");tooltipDiv.style.display="none";e.target.classList.remove("target-moving");document.documentElement.removeEventListener("mousemove",this.moveMouseToolTip);document.documentElement.removeEventListener("mouseup",this.removeMouseToolTip)},toolTipHtml:function(){if(!document.querySelectorAll(".tooltip-div").length){var tooltip=document.createElement("div");tooltip.setAttribute("class","tooltip-div");document.body.appendChild(tooltip)}},update:function(model){for(var i in model.changed.shortcode_attributes.changed){if("function"===typeof this[i]){this[i]()}else{this.render()}}},render:function(){this.el.innerHTML=this.template(this.model);$("body").trigger("karma_finish_render_html",[this.model]);return true},destroy:function(){this.$el.find(".karma-builder-element").each(function(){var childKey=$(this).attr("data-element-key");karmaBuilder.karmaModels.remove(karmaBuilder.karmaModels.where({element_key:childKey}))});this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},setAttributes:function(newAttributes,silent){var model=this.model,shortcodeAtrributes=JSON.parse(JSON.stringify(model.attributes.shortcode_attributes));shortcodeAtrributes.changed={};for(var attr in newAttributes){shortcodeAtrributes[attr]=newAttributes[attr];shortcodeAtrributes.changed[attr]=newAttributes[attr]}model.set({shortcode_attributes:shortcodeAtrributes},{silent:silent})},getAttributes:function(attributesNames){var model=this.model,shortcodeAtrributes=model.attributes.shortcode_attributes,attributeValue={};for(var attr in attributesNames){if(shortcodeAtrributes[attributesNames[attr]]){attributeValue[attributesNames[attr]]=shortcodeAtrributes[attributesNames[attr]]}}return attributeValue},findChildren:function(){return karmaBuilder.karmaModels.where({parent_key:this.model.attributes["element_key"]})},showSettingPanel:function(e){var form=$(e.currentTarget).data("form");this.removeSettingPanel();this.openSettingPanel(form);window.elementSettingPanel=new karmaBuilder.elementSettingPanel({model:this.model});elementSettingPanel.delegateEvents()},removeClass:function(el,className){if(this.el.classList){this.el.classList.remove(className)}else{this.el.className=this.el.className.replace(new RegExp("(^|\\b)"+className.split(" ").join("|")+"(\\b|$)","gi")," ")}},elementSelector:function(){return this.el.getAttribute("data-name").replace("_","-")+"-"+this.el.getAttribute("data-element-key")},renderCss:function(selector,attribute,value){document.querySelector("#style-"+this.elementSelector()).innerHTML=this.generateNewStyle(selector,attribute,value)},generateNewStyle:function(selector,attribute,value){var style=document.getElementById("style-"+this.elementSelector()).innerHTML,styleResult=style.split(/[{}]+/),newStyle="";if(style.indexOf(selector)<0){newStyle=style+selector+"{"+attribute+":"+value+";}";return newStyle}for(var i=0;i<styleResult.length;i++){if(i%2==1||""==styleResult[i])continue;if(selector==styleResult[i].replace(/^\s+|\s+$/g,"")){newStyle+=styleResult[i]+"{";newStyle+=this.generateStyleString(styleResult[i+1],attribute,value)}else{newStyle+=styleResult[i]+"{"+styleResult[i+1]+"}"}}return newStyle},generateStyleString:function(styleResult,attribute,value){var newStyle="";if(styleResult.indexOf(attribute)>=0){var regex=new RegExp(attribute+":([-0-9]*[a-z])*;");newStyle+=styleResult.replace(regex,attribute+":"+value+";");newStyle+="}"}else{newStyle+=styleResult+attribute+":"+value+";}"}return newStyle},gimzoAction:function(e,tempName,gizmoParam){if("bothSpacingGizmoTemplate"===tempName){var space=this.getAttributes(["space"]);gizmoParam["space"]=space.space}else if("leftSpacingGizmoTemplate"===tempName){var space=this.getAttributes(["leftspace"]);gizmoParam["leftspace"]=space.leftspace}else if("rightSpacingGizmoTemplate"===tempName){var space=this.getAttributes(["rightspace"]);gizmoParam["rightspace"]=space.rightspace}return gizmoParam},showElementGizmo:function(e){e.stopPropagation();$(".karma-builder-element").removeClass("karma-active-element");this.$el.addClass("karma-active-element")},removeGizmo:function(){$(document).off("click.removeGizmo").on("click.removeGizmo",function(){$(".karma-active-element").removeClass("karma-active-element")})},removeMoreSubmenu:function(){$(document).off("click.removeMoreSubmenu").on("click.removeMoreSubmenu",function(){$(".karma-more-submenu").removeClass("karma-more-submenu");$(".karma-open-more-options").removeClass("karma-open-more-options")})},showGizmoRelatedToMore:function(){var moreElements=this.el.querySelectorAll('div[data-form="more-panel"]:not(.karma-more-setting)'),moreButtonStatus=this.el.querySelectorAll(".karma-more-setting")[0].classList.contains("karma-open-more-options");for(var i=0;i<moreElements.length;i++){if(moreButtonStatus){moreElements[i].classList.remove("karma-more-submenu");this.el.querySelectorAll(".karma-more-setting")[0].classList.remove("karma-open-more-options")}else{moreElements[i].classList.add("karma-more-submenu");this.el.querySelectorAll(".karma-more-setting")[0].classList.add("karma-open-more-options")}}},openDropDownGzmo:function(e){var dropDownIcon=e.target.classList.contains("karma-drop-down-icon")?e.target:e.target.closest("button"),dropDownBox=dropDownIcon.nextElementSibling;if(null!=dropDownBox){dropDownBox.classList.toggle("open-drop-down-gizmo")}}});karmaBuilder.shortcodes.extend=function(child){var view=Backbone.View.extend.apply(this,arguments);if(true===child.denyEvents){return view}view.prototype.events=_.extend({},this.prototype.events,child.events);return view}})(jQuery,karmaBuilder);