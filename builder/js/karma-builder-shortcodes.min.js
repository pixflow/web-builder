(function($,karmaBuilder){karmaBuilder.shortcodes=karmaBuilder.elementSettingPanel.extend({events:{"mousedown > .karma-spacing-container .karma-spacing-dot-container":"showMouseToolTip","before/buildGizmo":"gimzoAction",click:"showElementGizmo","click .karma-align-center":"karmaTextShortcodealignCenter","click .karma-align-left":"karmaTextShortcodealignLeft","click .karma-align-right":"karmaTextShortcodealignRight","click .karma-more-setting":"showGizmoRelatedToMore","click .karma-drop-down-icon":"openDropDownGzmo","click .karma-set-bold-style":"setBoldStyle","click .karma-set-italic-style":"setItalicStyle","click .karma-set-underline-style":"setUnderlineStyle","click .karma-drop-down-box":"closeDropDownBox"},shortcodeParams:{},placeholderTemplate:'<div class="karma-element-placeholder {{ data.className }}" >'+'<div class="karma-inner-placeholder" >'+"</div>"+"</div>",shortcodeParams:{},initialize:function(options){this.template=options.template;if(this.model){_.bindAll(this,"update","destroy");this.model.bind("change",this.update);this.model.bind("destroy",this.destroy)}this.gizmoParams=options.gizmoParams;this.toolTipHtml();this.removeGizmo();this.karmaLinksDocumentClick();this.removeMoreSubmenu()},karmaTextShortcodealignLeft:function(){this.setAttributes({align:"left"},false)},karmaTextShortcodealignCenter:function(){this.setAttributes({align:"right"},false)},karmaTextShortcodealignRight:function(){this.setAttributes({align:"center"},false)},karmaLinksDocumentClick:function(){this.$el.find('.karma-document-click[href*="javascript:"]').off("click.documentClick").on("click.documentClick",function(){$(document).trigger("click")})},setItalicStyle:function(){document.execCommand("italic",true)},setUnderlineStyle:function(){document.execCommand("underline",true)},setBoldStyle:function(){document.execCommand("bold",true)},renderSettings:function(){this.createPlaceHolders();this.createGizmo();this.delegateEvents()},createPlaceHolders:function(){var getName=this.model.get("shortcode_name"),placeholderHTML;if("karma_column"!=getName&&"karma_section"!=getName){placeholderHTML=KarmaView.getUnderscoreTemplate(this.placeholderTemplate,{className:"karma-insert-between-elements-placeholder"});this.el.insertAdjacentHTML("afterend",placeholderHTML);if(1==this.model.get("order")){this.el.insertAdjacentHTML("beforebegin",placeholderHTML)}}else if("karma_column"==getName&&0==karmaBuilder.karmaModels.where({parent_key:this.model.get("element_key")}).length){placeholderHTML=KarmaView.getUnderscoreTemplate(this.placeholderTemplate,{className:"karma-column-placeholder"});this.el.querySelector(".karma-column").innerHTML=placeholderHTML}},getElementMap:function(elementName,form){if(this.shortcodeParams){this.shortcodeParams=JSON.parse(builderMaps)}return this.shortcodeParams[elementName][form]},update:function(model){for(var i in model.changed.shortcode_attributes.changed){if("function"===typeof this[i]){this[i]()}else{this.render()}}},render:function(){this.el.innerHTML=this.template(this.model);$("body").trigger("karma_finish_render_html",[this.model]);return true},destroy:function(){this.$el.find(".karma-builder-element").each(function(){var childKey=$(this).attr("data-element-key");karmaBuilder.karmaModels.remove(karmaBuilder.karmaModels.where({element_key:childKey}))});this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},setAttributes:function(newAttributes,silent){var model=this.model,shortcodeAtrributes=JSON.parse(JSON.stringify(model.attributes.shortcode_attributes));shortcodeAtrributes.changed={};for(var attr in newAttributes){shortcodeAtrributes[attr]=newAttributes[attr];shortcodeAtrributes.changed[attr]=newAttributes[attr]}model.set({shortcode_attributes:shortcodeAtrributes},{silent:silent})},getAttributes:function(attributesNames){var model=this.model,shortcodeAtrributes=model.attributes.shortcode_attributes,attributeValue={};for(var attr in attributesNames){if(shortcodeAtrributes[attributesNames[attr]]){attributeValue[attributesNames[attr]]=shortcodeAtrributes[attributesNames[attr]]}}return attributeValue},findChildren:function(){return karmaBuilder.karmaModels.where({parent_key:this.model.attributes["element_key"]})},showSettingPanel:function(e){var form=$(e.currentTarget).data("form");this.removeSettingPanel();this.openSettingPanel(form);window.elementSettingPanel=new karmaBuilder.elementSettingPanel({model:this.model});elementSettingPanel.delegateEvents()},removeClass:function(el,className){if(this.el.classList){this.el.classList.remove(className)}else{this.el.className=this.el.className.replace(new RegExp("(^|\\b)"+className.split(" ").join("|")+"(\\b|$)","gi")," ")}},elementSelector:function(){return this.el.getAttribute("data-name").replace("_","-")+"-"+this.el.getAttribute("data-element-key")},renderCss:function(selector,attribute,value){document.querySelector("#style-"+this.elementSelector()).innerHTML=this.generateNewStyle(selector,attribute,value)},generateNewStyle:function(selector,attribute,value){var style=document.getElementById("style-"+this.elementSelector()).innerHTML,styleResult=style.split(/[{}]+/),newStyle="";if(style.indexOf(selector)<0){newStyle=style+selector+"{"+attribute+":"+value+";}";return newStyle}for(var i=0;i<styleResult.length;i++){if(i%2==1||""==styleResult[i])continue;if(selector==styleResult[i].replace(/^\s+|\s+$/g,"")){newStyle+=styleResult[i]+"{";newStyle+=this.generateStyleString(styleResult[i+1],attribute,value)}else{newStyle+=styleResult[i]+"{"+styleResult[i+1]+"}"}}return newStyle},generateStyleString:function(styleResult,attribute,value){var newStyle="";if(styleResult.indexOf(attribute)>=0){var regex=new RegExp(attribute+":([-0-9]*[a-z])*;");newStyle+=styleResult.replace(regex,attribute+":"+value+";");newStyle+="}"}else{newStyle+=styleResult+attribute+":"+value+";}"}return newStyle}});karmaBuilder.shortcodes.extend=function(child){var view=Backbone.View.extend.apply(this,arguments);if(true===child.denyEvents){return view}view.prototype.events=_.extend({},this.prototype.events,child.events);return view};karmaBuilder.shortcodes=karmaBuilder.shortcodes.extend(karmaBuilder.gizmos.prototype)})(jQuery,karmaBuilder);