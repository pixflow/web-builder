(function($,karmaBuilder){karmaBuilder.shortcodes=Backbone.View.extend({events:{"before/buildGizmo":"gimzoAction","karma/before/deleteElement":"removeElementPlaceholder","karma/after/deleteElement":"createPlaceholderOnDelete","click .karma-drop-down-icon":"openDropDownGizmo",click:"showElementGizmo","click.childGizmo .karma-have-child-gizmo":"showElementChildGizmo","click.showGizmo .karma-more-setting":"showGizmoRelatedToMore","click .karma-drop-down-box":"updateDropDownBox","click .karma-delete-element-setting":"deleteElementBox","click .karma-duplicate-element-setting":"duplicateElement","click.removeActiveElement":"callBlur","click .karma-delete-message-box-delete-button":"DeleteElement","click .karma-delete-message-box-cancel-button":"cancelDeleteElement","click .karma-delete-message-box":"cancelDeleteElement","click .karma-delete-message-container":"deleteBoxStopPropagation","click .karma-new-section-button":"newSectionDropDown"},placeholderTemplate:'<div class="karma-element-placeholder {{ data.className }}" >'+'<div class="karma-inner-placeholder" >'+"</div>"+"</div>",alignmentPlaceholderTemplate:'<div class="karma-left-alignment-placeholder" data-element-align="left" >'+"</div>"+'<div class="karma-center-alignment-placeholder" data-element-align="center" >'+"</div>"+'<div class="karma-right-alignment-placeholder" data-element-align="right" >'+"</div>",initialize:function(options){this.template=options.template;if(this.model){_.bindAll(this,"update","destroy");this.model.bind("change",this.update);this.model.bind("destroy",this.destroy)}this.gizmoParams=options.gizmoParams;this.toolTipHtml();this.karmaLinksDocumentClick();this.initSortable()},callBlur:function(){if(null==this.el.querySelector("div[contenteditable=true]")){document.activeElement.blur()}},initSortable:function(){var elementName=this.model.get("shortcode_name"),that=this;if("karma_column"!=elementName&&"karma_section"!=elementName){that.$el.find(".karma-element-content").draggable({zIndex:999999,helper:"clone",appendTo:"#karma-builder-layout",cancel:".karma-active-element",helper:function(event){return $(event.target).closest(".karma-builder-element").clone()},start:function(event,UI){KarmaView.createOverlay();var helperNode=UI.helper[0],originalElement=$(this)[0],oldStyle=helperNode.getAttribute("style"),newStyle=oldStyle+"width:"+originalElement.offsetWidth+"px;height:"+originalElement.offsetHeight+"px;transform:scale(.7);opacity:.7";helperNode.setAttribute("style",newStyle);originalElement.parentElement.classList.add("karma-self-placeholder")},drag:function(event,UI){KarmaView.scroll(UI,event);KarmaView.detectDropAreas(event,UI)},stop:function(event){KarmaView.removeOverlay();clearInterval(KarmaView.flyScroll);var dropArea=document.querySelector(".karma-show-placeholder"),originalElement=$(this)[0],orginalContainer=originalElement.closest(".karma-builder-element");if(null!=dropArea&&dropArea.classList.contains("karma-element-placeholder-"+orginalContainer.getAttribute("data-element-key"))){orginalContainer.classList.remove("karma-self-placeholder")}else if(null!=dropArea&&dropArea.classList.contains("karma-alignment-placeholder")){that.alignmentPlaceholder(originalElement,dropArea,event)}else if(null!=dropArea&&!dropArea.classList.contains("karma-self-placeholder")){that.beforeSortElement(dropArea,orginalContainer)}else if(null==dropArea&&null!=originalElement&&orginalContainer.classList.contains("karma-self-placeholder")){orginalContainer.classList.remove("karma-self-placeholder")}KarmaView.removePlaceHolders()}})}},alignmentPlaceholder:function(originalElement,dropArea,event){var alignPosition=document.elementFromPoint(event.clientX,event.clientY).getAttribute("data-element-align");if(undefined!=alignPosition){this.setAttributes({elementalign:alignPosition},false)}originalElement.closest(".karma-builder-element").classList.remove("karma-self-placeholder");dropArea.classList.remove("karma-show-placeholder")},elementalign:function(){var regex=new RegExp("(?:^|\\s)karma-element-alignment-(.*?)(?!\\S)"),align=this.getAttributes(["elementalign"]),element=this.el;element.className=element.className.replace(regex," karma-element-alignment-"+align.elementalign)},topspacepadding:function(){var that=this;this.renderCss("#"+that.elementSelector(),"padding-top",that.getAttributes(["topspacepadding"]).topspacepadding+"px")},removeActiveElement:function(){var activeElement=document.querySelector(".karma-active-element");if(null!=activeElement){activeElement.classList.remove("karma-active-element")}},beforeSortElement:function(dropArea,originalElement){if(null==dropArea){originalElement.classList.remove("karma-self-placeholder");return}var viewObject=$(originalElement).backboneView(),oldParentKey=viewObject.model.get("element_key"),newParentKey=dropArea.closest(".karma-builder-element").getAttribute("data-element-key"),parentColumnView=viewObject.$el.parents(".karma-builder-element").backboneView(),elementID=viewObject.model.get("shortcode_name").replace(/_/g,"-")+"-"+viewObject.model.get("element_key"),script=$("#script-"+elementID).clone(),style=$("#style-"+elementID).clone();this.sortElement(viewObject,dropArea,newParentKey);this.removeExtraAssets(elementID);viewObject.$el.append(script);viewObject.$el.append(style);KarmaView.$el.trigger("karma/after/dropElement",[newParentKey]);KarmaView.$el.trigger("karma/after/dropElement",[oldParentKey]);parentColumnView.createPlaceHolders()},sortElement:function(viewObject,dropArea,newParentKey){var htmlOBJ=viewObject.$el;viewObject.el.parentNode.removeChild(viewObject.el.nextElementSibling);viewObject.el.outerHTML="";$(dropArea).replaceWith(htmlOBJ);viewObject.el.classList.remove("karma-self-placeholder");viewObject.model.set({parent_key:newParentKey,order:1},{silent:true});viewObject.createPlaceHolders();if("karma_image"==viewObject.model.get("shortcode_name")){var elementWidth=viewObject.el.closest(".karma-column-margin").offsetWidth+"px";viewObject.el.querySelector(".karma-image-resize").style.width=elementWidth;viewObject.el.querySelector(".karma-image-resize-crop").style.width=elementWidth}},karmaLinksDocumentClick:function(){this.$el.find('.karma-document-click[href*="javascript:"]').off("click.documentClick").on("click.documentClick",function(){$(document).trigger("click")})},renderSettings:function(){this.createPlaceHolders();this.createGizmo();this.delegateEvents();this.$el.trigger("karma/finish/renderElement")},createPlaceHolders:function(){var getName=this.model.get("shortcode_name"),elementKey=this.model.get("element_key"),placeholderHTML;if("karma_column"!=getName&&"karma_section"!=getName){placeholderHTML=KarmaView.getUnderscoreTemplate(this.placeholderTemplate,{className:"karma-insert-between-elements-placeholder karma-element-placeholder-"+elementKey});this.el.insertAdjacentHTML("afterend",placeholderHTML);if(1==this.model.get("order")){this.el.insertAdjacentHTML("beforebegin",placeholderHTML)}this.createSelfPlaceholder()}else if("karma_column"==getName&&0==karmaBuilder.karmaModels.where({parent_key:this.model.get("element_key")}).length){placeholderHTML=KarmaView.getUnderscoreTemplate(this.placeholderTemplate,{className:"karma-column-placeholder"});this.el.querySelector(".karma-column-margin").innerHTML=placeholderHTML}else if("karma_section"==getName){placeholderHTML=KarmaView.getUnderscoreTemplate(this.placeholderTemplate,{className:"karma-insert-between-sections-placeholder karma-section-placeholder-"+elementKey});this.el.insertAdjacentHTML("afterend",placeholderHTML)}},createSelfPlaceholder:function(){if(undefined==this.el.querySelector(".karma-alignment-placeholder")){var alignmentPlaceholder=KarmaView.getUnderscoreTemplate(this.alignmentPlaceholderTemplate),div=document.createElement("div");div.classList.add("karma-alignment-placeholder");div.innerHTML=alignmentPlaceholder;this.el.appendChild(div)}},update:function(model){for(var i in model.changed.shortcode_attributes.changed){if("function"===typeof this[i]){this[i]()}else{this.render()}}},render:function(){this.el.innerHTML=this.template(this.model)},destroy:function(){var parentKey=this.model.get("parent_key"),elementKey=this.model.get("element_key"),elementName=this.model.get("shortcode_name");this.beforeDeleteElements();this.$el.find(".karma-builder-element").each(function(){var childKey=$(this).attr("data-element-key");karmaBuilder.karmaModels.remove(karmaBuilder.karmaModels.where({element_key:childKey}))});this.undelegateEvents();this.$el.removeData().unbind();this.remove();this.removeExtraAssets(elementName.replace(/_/g,"-")+"-"+elementKey);karmaBuilder.karmaModels.remove(this.model);Backbone.View.prototype.remove.call(this);this.afterDeleteElement(parentKey,elementName);this.loadBlankPage()},loadBlankPage:function(){var karmaLayout=document.querySelector("#karma-builder-layout");if(null==document.querySelector(".karma-section")){var template=KarmaView.getWpTemplate("karma-blank-page");karmaLayout.innerHTML=template}},beforeDeleteElements:function(){this.$el.next(".karma-insert-between-elements-placeholder").remove();if("karma_section"==this.model.get("shortcode_name")){this.$el.next(".karma-new-section").remove()}},reorderAfterDelete:function(parentKey){if(""==parentKey){KarmaView.reorderSections()}else{KarmaView.$el.trigger("karma/after/dropElement/",[parentKey])}},afterDeleteElement:function(parentKey,elementName){this.reorderAfterDelete(parentKey);if("karma_column"!=elementName&&"karma_section"!=elementName){var columnInstance=$('[data-element-key="'+parentKey+'"]').backboneView(),parentSection=columnInstance.el.closest(".karma-section");columnInstance.createPlaceHolders();this.checkIfColumnsEmpty(parentSection)}},checkIfColumnsEmpty:function(section){if(0==section.querySelectorAll(".karma-column .karma-builder-element").length){$(section).find('.karma-builder-element[data-name="karma_column"]').addClass("karma-empty-column")}},duplicateElement:function(){var that=this,duplicatedElementModel={parent:JSON.parse(JSON.stringify(that.model)),childes:that.getChildElements(that.model.get("element_key"))};KarmaView.renderElementsChildes(duplicatedElementModel,this)},getChildElements:function(parentElementKey){var childElementsModel=karmaBuilder.karmaModels.where({parent_key:parentElementKey}),that=this,elementsModel=[];_.each(childElementsModel,function(model){var elementModel={parent:JSON.parse(JSON.stringify(model)),childes:that.getChildElements(model.get("element_key"))};elementsModel.push(elementModel)});return elementsModel},deleteElementBox:function(){var deleteBox=this.el.querySelector(".karma-delete-message-box"),deleteContainer=this.el.querySelector(".karma-delete-message-container");if(null==deleteBox){var template=KarmaView.getWpTemplate("karma-delete-message-box");this.$el.append(template)}else{if(deleteBox.classList.contains("karma-delete-box-animation")){deleteBox.classList.remove("karma-delete-box-animation")}if(deleteContainer.classList.contains("karma-delete-container-animation")){deleteContainer.classList.remove("karma-delete-container-animation")}deleteBox.style.display="flex"}},cancelDeleteElement:function(){var deleteBox=this.el.querySelector(".karma-delete-message-box"),deleteContainer=this.el.querySelector(".karma-delete-message-container");deleteContainer.classList.add("karma-delete-container-animation");deleteBox.classList.add("karma-delete-box-animation");setTimeout(function(){deleteBox.style.display="none"},300)},DeleteElement:function(){var that=this;var deleteBox=this.el.querySelector(".karma-delete-message-box"),deleteContainer=this.el.querySelector(".karma-delete-message-container"),selectAll=this.$el.find(".karma-builder-element div:not(.karma-delete-message-box)");deleteContainer.classList.add("karma-delete-container-animation");deleteBox.classList.add("karma-delete-box-animation");selectAll.css("display","none");setTimeout(function(){that.destroy()},100)},deleteBoxStopPropagation:function(e){e.stopPropagation()},removeExtraAssets:function(elementID){var style=$("#style-"+elementID),script=$("#script-"+elementID);console.log("#style-"+elementID);if(script.length){script.remove()}if(style.length){style.remove()}},setAttributes:function(newAttributes,silent){var model=this.model,shortcodeAttributes=JSON.parse(JSON.stringify(model.attributes.shortcode_attributes));shortcodeAttributes.changed={};for(var attr in newAttributes){shortcodeAttributes[attr]=newAttributes[attr];shortcodeAttributes.changed[attr]=newAttributes[attr]}model.set({shortcode_attributes:shortcodeAttributes},{silent:silent})},getAttributes:function(attributesNames){var model=this.model,shortcodeAttributes=JSON.parse(JSON.stringify(model.attributes.shortcode_attributes)),attributeValue={};for(var attr in attributesNames){if("undefined"!=typeof shortcodeAttributes[attributesNames[attr]]){attributeValue[attributesNames[attr]]=shortcodeAttributes[attributesNames[attr]]}}return attributeValue},findChildren:function(){return karmaBuilder.karmaModels.where({parent_key:this.model.attributes["element_key"]})},showSettingPanel:function(e){e.stopPropagation();this.removeElementChildGizmo();$(".open-drop-down-gizmo").removeClass("open-drop-down-gizmo");var form=$(e.currentTarget).data("form"),that=this;KarmaView.closeElementPanel().removeSettingPanel();window.elementSettingPanel=new window.top.karmaBuilderActions.elementSettingPanel({model:this.model,viewInstance:that});var result=elementSettingPanel.openSettingPanel(form);elementSettingPanel.delegateEvents();if(false==result){elementSettingPanel.removeSettingPanel()}},removeClass:function(el,className){if(this.el.classList){this.el.classList.remove(className)}else{this.el.className=this.el.className.replace(new RegExp("(^|\\b)"+className.split(" ").join("|")+"(\\b|$)","gi")," ")}},elementSelector:function(){return this.el.getAttribute("data-name").replace(/_/g,"-")+"-"+this.el.getAttribute("data-element-key")},renderCss:function(selector,attribute,value){document.querySelector("#style-"+this.elementSelector()).innerHTML=this.generateNewStyle(selector,attribute,value)},generateNewStyle:function(selector,attribute,value){var oldStyle=document.querySelector("#style-"+this.elementSelector()).innerHTML,regex=/(.*?){(.*?)}/g,pattern=new RegExp(regex),selector=selector.trim(),content="",result;if(""!=oldStyle){while((result=pattern.exec(oldStyle))!==null){if(result.index===regex.lastIndex){regex.lastIndex++}if(result[1].trim()==selector){content=result[2];break}}}if(""!=content){var splitContent=content.split(";"),cssProperty={};_.each(splitContent,function(property){var cssString=property.split(/(.*?)(:([^\/]))/g);if(""!=cssString[1]&&undefined!=cssString[1]){cssProperty[cssString[1]]=cssString[3]+cssString[4]}});cssProperty[attribute]=value;oldStyle=this.removeOldSelector(selector,oldStyle);return oldStyle+this.generateStyleString(selector,cssProperty)}else{var cssProperty={};cssProperty[attribute]=value;return oldStyle+this.generateStyleString(selector,cssProperty)}},removeOldSelector:function(selector,oldStyle){var pattern=selector.replace(/\*/g,"\\*")+"{(.*?)}",regex=new RegExp(pattern,"g");return oldStyle.replace(regex,"")},generateStyleString:function(selector,cssProperty){var style=selector+"{";_.each(cssProperty,function(value,property){style+=property+":"+value+";"});style+="}";return style}});karmaBuilder.shortcodes.extend=function(child){var view=Backbone.View.extend.apply(this,arguments);if(true===child.denyEvents){return view}view.prototype.events=_.extend({},this.prototype.events,child.events);return view};karmaBuilder.shortcodes=karmaBuilder.shortcodes.extend(karmaBuilder.gizmos.prototype)})(jQuery,karmaBuilder);