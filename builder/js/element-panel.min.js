(function($,karmaBuilder){karmaBuilder.elementPanel=Backbone.View.extend({flyScroll:"",events:{"click .element-panel-add-element-button":"openAddElementView",click:"stopClickInPanel","click .karma-premium-deactivate":"checkingPermium","karma/after/finish_element_panel":"initDraggable","mousedown .karma-element-panel-list .karma-element-single-element":"addGrabHandler","mouseup .karma-element-panel-list .karma-element-single-element":"removeGrabHandler","click li.karma-addcontent":"elementPanelTab","input .search-text":"searchInElements","click .karma-builder-addcontent ul li":"categoryFilterActive","click .karma-builder-element-panel-gather-menu":"openCategoryMenu","karma/after/dropElement":"REOrderElements"},initialize:function(){this.setElement($('<div class="karma-element-panel-container">'));this.render();this.createAddElementPanel();this.createTemplatesPanel();this.createUnsplashPanel();this.$el.trigger("karma/after/finish_element_panel",[this]);this.setEvents()},setEvents:function(){var that=this;$(document).on("click",function(){that.closeElementPanel()})},stopClickInPanel:function(e){e.stopPropagation()},render:function(){document.body.appendChild(this.el)},elementPanelTab:function(e){var target=$(e.target);if(target.hasClass("karma-addcontent")){var orginalSelector=target}else{var orginalSelector=target.closest(".karma-addcontent")}document.querySelector(".karma-active-tab")&&document.querySelector(".karma-active-tab").classList.remove("karma-active-tab");var tabData=orginalSelector.attr("data-tab"),tabContent=document.querySelector("."+tabData);if(null!=tabContent){tabContent.classList.add("karma-active-tab")}},createAddElementPanel:function(){var templateParams={};templateParams["elementInfo"]=KarmaView.getElementInfo();var template="<div>"+KarmaView.getWpTemplate("karma-element-panel-add-element",templateParams)+"</div>";this.el.appendChild($(template)[0])},createTemplatesPanel:function(){var template="<div>"+KarmaView.getWpTemplate("karma-element-panel-templates",{})+"</div>";this.el.appendChild($(template)[0])},createUnsplashPanel:function(){var template="<div>"+KarmaView.getWpTemplate("karma-element-panel-unsplash",{})+"</div>";this.el.appendChild($(template)[0])},openAddElementView:function(){var addElement=document.querySelector(".karma-element-panel-add-element-view");var elementPanelShowClass="element-panel-show";if(null!=addElement){if(addElement.classList.contains(elementPanelShowClass)){addElement.classList.remove("element-panel-show")}else addElement.classList.add("element-panel-show")}this.scrollElementPanel()},closeElementPanel:function(){var addElement=document.querySelector(".karma-element-panel-add-element-view");if(null!=addElement){addElement.classList.remove("element-panel-show")}},scrollElementPanel:function(){$(".karma-elements").niceScroll({cursorcolor:"#A9A9A9",cursorwidth:"3px",cursoropacitymax:.56,railalign:"left",cursorborder:"none"})},addGrabHandler:function(e){var target=$(e.target);if(target.hasClass("karma-element-single-element")){target.addClass("karma-grab-element")}else{target.closest(".karma-element-single-element").addClass("karma-grab-element")}},removeGrabHandler:function(e){var target=$(e.target);if(target.hasClass("karma-element-single-element")){target.removeClass("karma-grab-element")}else{target.closest(".karma-element-single-element").removeClass("karma-grab-element")}},scroll:function(element){var element=element.helper,toolbarHeight=100;this.scrollToDown(element,toolbarHeight);this.scrollToTop()},scrollToDown:function(element,toolbarHeight){var that=this;if(element.position().top+toolbarHeight>window.innerHeight+$(window).scrollTop()){clearInterval(that.flyScroll);that.flyScroll=setInterval(function(){if(window.innerHeight+window.scrollY==document.body.offsetHeight){clearInterval(that.flyScroll)}$(window).scrollTop($(window).scrollTop()+5)},1)}else{clearInterval(that.flyScroll)}},scrollToTop:function(){var that=this;if(event.clientY<50){clearInterval(that.flyScroll);that.flyScroll=setInterval(function(){if($(window).scrollTop()==0){clearInterval(that.flyScroll)}$(window).scrollTop($(window).scrollTop()-5)},1)}},getParentElementInfo:function(element){var parentElement=element.closest(".karma-builder-element");if(null==parentElement){return false}var elementName=parentElement.getAttribute("data-name"),info={node:parentElement,name:elementName};return info},overlayBehavior:function(event,UI){var overlay=document.querySelector(".karma-overlay-on-dragging"),targetElement;overlay.style.display="none";UI.helper.get(0).style.display="none";targetElement=document.elementFromPoint(event.clientX,event.clientY);overlay.style.display="block";UI.helper.get(0).style.display="flex";return targetElement},removePlaceHolders:function(){var activePlaceHolder=document.querySelector(".karma-show-placeholder");if(null!=activePlaceHolder){activePlaceHolder.classList.remove("karma-show-placeholder")}},detectDropAreas:function(event,UI){var targetElement=this.overlayBehavior(event,UI);if(targetElement.classList.contains(".karma-element-placeholder")||null!=targetElement.closest(".karma-element-placeholder")){return false}targetElement=this.getParentElementInfo(targetElement);this.removePlaceHolders();if(false==targetElement||"karma_section"==targetElement.name){return false}else if("karma_column"==targetElement.name){var placeHolder=targetElement.node.querySelector(".karma-column-placeholder");if(null!=placeHolder){placeHolder.classList.add("karma-show-placeholder")}}else{this.showElementsPlaceHolder(event,targetElement)}return true},showElementsPlaceHolder:function(event,targetElement){var scrollTop=document.body.scrollTop,topPosition=targetElement.node.getBoundingClientRect().top+scrollTop,elementHeight=targetElement.node.offsetHeight,elementHalf=topPosition+elementHeight/2;if(event.clientY+scrollTop<elementHalf){targetElement.node.previousElementSibling.classList.add("karma-show-placeholder")}else{targetElement.node.nextElementSibling.classList.add("karma-show-placeholder")}},createOverlay:function(){var overlay=document.querySelector(".karma-overlay-on-dragging");if(null==overlay){overlay=document.createElement("div");overlay.classList.add("karma-overlay-on-dragging");document.body.appendChild(overlay)}else{overlay.style.display="block"}},removeOverlay:function(){var overlay=document.querySelector(".karma-overlay-on-dragging");overlay.style.display="none"},checkingPermium:function(){var permiumTemplate=document.querySelector(".element-panel-permium");document.querySelector(".karma-active-tab")&&document.querySelector(".karma-active-tab").classList.remove("karma-active-tab");permiumTemplate.classList.add("karma-active-tab")},initDraggable:function(){var that=this;$(".karma-element-single-element").draggable({appendTo:"body",containment:"document",cursorAt:{top:20,left:50},helper:"clone",start:function(){var DOMOBJ=$(this).get(0);DOMOBJ.classList.add("karma-start-dragging","karma-grab-element");that.createOverlay()},drag:function(event,UI){that.scroll(UI);that.detectDropAreas(event,UI)},stop:function(event,UI){var DOMOBJ=$(this).get(0),dropArea=document.querySelector(".karma-show-placeholder");DOMOBJ.classList.remove("karma-start-dragging","karma-grab-element");clearInterval(that.flyScroll);that.removeOverlay();that.prepareBeforeDrop(dropArea,UI.helper.attr("data-element-name"));that.removePlaceHolders()}})},prepareBeforeDrop:function(whereToDrop,elementName){if(null==whereToDrop){return false}var validateModel=this.getValidateElementModel(whereToDrop,elementName),CID=karmaBuilder.karmaModels.add(validateModel).cid,model=karmaBuilder.karmaModels.get({cid:CID});whereToDrop.outerHTML=KarmaView.createBuilderModel(model);KarmaView.createNewElement(elementName.replace("karma_",""),model,true);this.$el.trigger("karma/after/dropElement",[validateModel["parent_key"]])},getValidateElementModel:function(whereToDrop,elementName){return{shortcode_name:elementName,shortcode_content:"",element_key:KarmaView.createNewElementKey(),shortcode_attributes:$(document).triggerHandler("karma/before/createElement/"+elementName),order:1,parent_key:whereToDrop.closest(".karma-builder-element").getAttribute("data-element-key")}},REOrderElements:function(e,parent_key){var childElements=document.querySelectorAll('[data-element-key="'+parent_key+'"] .karma-builder-element'),order=1;_.each(childElements,function(element){var elementInstance=$(element).backboneView();elementInstance.model.attributes.order=order;order++})},searchInElements:function(e){var searchValue=$(e.target).val();$(".karma-element-single-element").hide();if(""!=searchValue.trim()){$('[data-category*="'+searchValue.trim()+'"]').css("display","flex")}else{$(".karma-element-single-element").css("display","flex")}},categoryFilterActive:function(e){var target=$(e.target),karmaAddcontentClass=target.closest(".karma-addcontent");if(karmaAddcontentClass){$(".karma-addcontent").removeClass("karma-addcontent-active");karmaAddcontentClass.addClass("karma-addcontent-active")}},openCategoryMenu:function(e){var target=$(e.target),categoryMenu=target.closest(".karma-builder-element-panel-gather-menu");if(target.closest("svg").length){categoryMenu.toggleClass("karma-open-element-category-dropdown")}}})})(jQuery,karmaBuilder);