var karmaBuilderActions=karmaBuilderActions||{};(function($,karmaBuilderActions){"use strict";karmaBuilderActions.view=Backbone.View.extend({events:{"click .builder-publish":"karmaPublish","karma/finish/animation":"publishAnimation","karma/finish/iframeInit.settingPanelHtml":"settingPanelHtml"},karmaIframe:null,elementInfo:{},initialize:function(){},addGrabHandler:function(e,UI){if(UI.helper.hasClass("ui-draggable")){UI.helper.addClass("karma-grab-element")}else{UI.helper.closest(".ui-draggable").addClass("karma-grab-element")}},removeGrabHandler:function(e,UI){var target=UI.helper;if(target.hasClass("ui-draggable")){target.removeClass("karma-grab-element")}else{target.closest(".ui-draggable").removeClass("karma-grab-element")}},settingPanelHtml:function(){window.karmaElementPanel=new karmaBuilderActions.elementPanel},createOverlay:function(){var overlay=document.querySelector(".karma-overlay-on-dragging");if(null==overlay){overlay=document.createElement("div");overlay.classList.add("karma-overlay-on-dragging");document.body.appendChild(overlay)}else{overlay.style.display="block"}},removeOverlay:function(){var overlay=document.querySelector(".karma-overlay-on-dragging");overlay.style.display="none"},initDraggable:function(selector){var that=this;$(selector).draggable({appendTo:"body",containment:"document",cursorAt:{top:40,left:40},helper:"clone",start:function(event,UI){$(".karma-elements").getNiceScroll().remove();this.classList.add("karma-start-dragging");UI.helper[0].style.transform="";that.addGrabHandler(event,UI);that.createOverlay()},drag:function(event,UI){that.getIframe().KarmaView.scroll(UI,event);that.getIframe().KarmaView.detectDropAreas(event,UI)},stop:function(event,UI){var dropArea=that.getIframe().document.querySelector(".karma-show-placeholder");this.classList.remove("karma-start-dragging");that.removeGrabHandler(event,UI);clearInterval(that.flyScroll);that.removeOverlay();that.getIframe().KarmaView.prepareBeforeDrop(dropArea,UI.helper[0].getAttribute("data-element-name"),UI.helper[0].getAttribute("data-element-type"));that.getIframe().KarmaView.removePlaceHolders();window.karmaElementPanel.scrollElementPanel()}})},getElementInfo:function(name){if(0===Object.keys(this.elementInfo).length){this.elementInfo=JSON.parse(this.getIframe().builderElementInfo)}if(name){return this.elementInfo[name]}else{return this.elementInfo}},openMediaLibrary:function(addImgLink,callBack,view){var frame,that=this;if("undefined"==typeof view){view={}}addImgLink.addEventListener("click",function(){if(frame){frame.open();return}frame=wp.media({title:"Select or Upload Media Of Your Chosen Persuasion",button:{text:"Use this media"},multiple:false});frame.on("select",callBack.bind(frame,frame,view));frame.open();that.getIframe().KarmaView.preventFromScrollingOnParent($(".attachments-browser .attachments"))},false)},getIframe:function(){if(null==this.karmaIframe){this.karmaIframe=document.getElementById("karma-builder-iframe").contentWindow.window}return this.karmaIframe},karmaPublish:function(){var karmaIframeView=this.getIframe().KarmaView,button=document.querySelector(".builder-publish");button.classList.add("karma-publish-animation");if("undefined"!=typeof karmaIframeView){karmaIframeView.$el.trigger("karma/before/publish")}},publishAnimation:function(){var karmaPublishButton=document.querySelector(".builder-publish");karmaPublishButton.classList.add("karma-publish-finish-animation");setTimeout(function(){karmaPublishButton.querySelector(".builder-publish-text").style.opacity="0"},480);setTimeout(function(){karmaPublishButton.querySelector(".builder-publish-text").style.opacity="1";karmaPublishButton.style.transition="none";karmaPublishButton.classList.remove("karma-publish-animation","karma-publish-finish-animation")},2400)}});$(document).ready(function(){window.karmaBuilderEnviroment=new karmaBuilderActions.view({el:$(document)})})})(jQuery,karmaBuilderActions);