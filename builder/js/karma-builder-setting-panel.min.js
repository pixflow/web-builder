(function($,karmaBuilderActions){karmaBuilderActions.elementSettingPanel=karmaBuilderActions.view.extend({KarmaView:null,shortcodeParams:{},viewInstance:{},events:{"click.stopParent":"stopFromCallingParent","click .delete-karma-element":"removeElement","click .karma-setting-panel-close-svg":"removeSettingPanel","input #karma-element-setting-panel-container input:not(.no-trigger)":"updateModel","input #karma-element-setting-panel-container textarea:not(.no-trigger)":"updateModel","change #karma-element-setting-panel-container input[type=checkbox]":"updateModel"},initialize:function(options){this.viewInstance=options.viewInstance;karmaElementPanel.closeElementPanel();this.setElement($("body"))},getElementMap:function(elementName,form){if(this.shortcodeParams){this.shortcodeParams=JSON.parse(this.getIframe().builderMaps)}return this.shortcodeParams[elementName][form]},bindDragEvents:function(){$("#karma-element-setting-panel-container").draggable({containment:"body",scroll:true,scrollSpeed:100,distance:10,cancel:".karma-shortcode-setting-panel-extra, input, .rangeslider__handle",start:function(){karmaBuilderEnviroment.createOverlay()},stop:function(){karmaBuilderEnviroment.removeOverlay()},drag:function(){$(this).css({width:"",height:""})}})},stopFromCallingParent:function(e){e.stopPropagation();$(document).trigger("click.hideColorPickerContainer")},removeElement:function(){if(!confirm("are you sure?"))return;this.model.destroy();this.removeSettingPanel()},openSettingPanel:function(form){this.KarmaView=document.getElementById("karma-builder-iframe").contentWindow.window.KarmaView;var html=document.createElement("div"),formHtml=this.formBuilder(form);if(null==formHtml){return false}var elementAttributes=this.model.attributes,elementSelector=elementAttributes["shortcode_name"].replace("_","-")+"-"+elementAttributes.element_key;html.innerHTML=this.KarmaView.getWpTemplate("karma-element-setting-panel",{headerTitle:formHtml.title,content:formHtml.content,selector:elementSelector},1);document.body.appendChild(html);this.bindDragEvents();this.applyDependency();$(document).trigger("karma_finish_form_builder",[this.viewInstance]);this.scrollSettingPanel();return true},updateElementParams:function(model,elementParam){for(var index in elementParam.params){var paramName=elementParam.params[index].name;if("gridlayout"===paramName){elementParam.params[index].value=this.viewInstance.currentGrid().length}if(undefined!==model.shortcode_attributes[paramName]){elementParam.params[index].value=model.shortcode_attributes[paramName]}}return elementParam},formBuilder:function(form){var elementModel=this.model.attributes,elementParams=this.getElementMap(elementModel.shortcode_name,form);if(null==elementParams){return}var popup=document.createElement("div"),settingPanelHeight=elementParams.height,karmaFormHtml='<form id="karma-Builder-form" style="height :'+settingPanelHeight+'px"  data-height ="'+settingPanelHeight+'"  autocomplete="off" onsubmit="return false">',formBuilderContents=this.formBuilderContentHtml(form);karmaFormHtml+='<div id="elementRow" >'+formBuilderContents+"</div> </form>";popup.innerHTML=karmaFormHtml;return{content:popup.innerHTML,title:elementParams.title}},formBuilderContentHtml:function(form){var elementModel=this.model.attributes,elementParams=this.getElementMap(elementModel.shortcode_name,form),elementParams=this.updateElementParams(elementModel,elementParams);return this.formBuilderContentAction(elementParams)},formBuilderContentAction:function(elementParams){var groupHtml="",controllerSource,groupHtml_group=[];for(var counter in elementParams.params){if(!elementParams.params[counter].group&&"switch-panel"!=elementParams.params[counter].type){controllerSource=this.KarmaView.getWpTemplate("karma-"+elementParams.params[counter].type+"-controller",elementParams.params[counter],1);groupHtml+=this.setGeneralContainer(controllerSource,elementParams.params[counter])}else if("switch-panel"===elementParams.params[counter].type){if("undefined"!==typeof elementParams.params[counter].form){elementParams.params[counter]["view"]=this;elementParams.params[counter]["formBuilder"]=true;controllerSource=this.KarmaView.getWpTemplate("karma-"+elementParams.params[counter].type+"-controller",elementParams.params[counter],1);groupHtml+=this.setGeneralContainer(controllerSource,elementParams.params[counter])}else{elementParams.params[counter]["formBuilder"]=false;controllerSource=this.KarmaView.getWpTemplate("karma-"+elementParams.params[counter].type+"-controller",elementParams.params[counter],1);groupHtml+=this.setGeneralContainer(controllerSource,elementParams.params[counter])}}else{if(undefined===groupHtml_group[elementParams.params[counter].group]){groupHtml_group[elementParams.params[counter].group]={items:[],title:elementParams.params[counter].group}}controllerSource=this.KarmaView.getWpTemplate("karma-"+elementParams.params[counter].type+"-controller",elementParams.params[counter],1);var html=this.setGeneralContainer(controllerSource,elementParams.params[counter]);groupHtml_group[elementParams.params[counter].group]["items"].push(html)}var formBuilderGroupHtml=this.formBuilderGroupHtml(groupHtml_group)}var formBuilderContent=groupHtml+formBuilderGroupHtml;return formBuilderContent},formBuilderGroupHtml:function(htmlGroup){var settingPanelGroup="",controllerSource;for(var counter in htmlGroup){controllerSource=this.KarmaView.getWpTemplate("karma-setting-panel-groups-extend",htmlGroup[counter],1);settingPanelGroup+=this.setGeneralContainer(controllerSource,htmlGroup[counter])}return settingPanelGroup},removeSettingPanel:function(){var settingPanel=document.querySelector("#karma-element-setting-panel-container");$(document).trigger("click.hideColorPickerContainer");if(null!=settingPanel){settingPanel.parentNode.removeChild(settingPanel)}if("undefined"!=typeof karmaBuilderEnviroment.getIframe().elementSettingPanel){karmaBuilderEnviroment.getIframe().elementSettingPanel.undelegateEvents();karmaBuilderEnviroment.getIframe().elementSettingPanel.$el.removeData().unbind();delete karmaBuilderEnviroment.getIframe().elementSettingPanel}},setGeneralContainer:function(source,dependencyParams){var classes="karma-controller-"+dependencyParams.name,newSource='<div class="karma-controller '+classes+'"';if("undefined"!=typeof dependencyParams.dependency){newSource+="data-dependency='"+JSON.stringify(dependencyParams.dependency)+"'";newSource+="data-dependency-element='"+dependencyParams.dependency.controller+"'"}newSource+=" >"+source+"</div>";return newSource},applyDependency:function(){var dependentElements=document.querySelectorAll(".karma-controller[data-dependency]"),that=this,dependecyInfo;_.each(dependentElements,function(dependentElement){dependecyInfo=JSON.parse(dependentElement.getAttribute("data-dependency")),dependentElementOBJ=document.querySelector('input[name="'+dependecyInfo.controller+'"]');that.applyDependencyOnLoad(dependentElement,dependecyInfo,dependentElementOBJ);dependentElementOBJ.addEventListener("change",function(){that.doDependency(dependentElement,this.value)})})},applyDependencyOnLoad:function(dependentElement,dependencyInfo,dependentElementOBJ){var dependentValue=dependentElementOBJ.value;this.doDependency(dependentElement,dependentValue)},doDependency:function(dependentElement,dependentValue){var isHide,dependencyInfo=JSON.parse(dependentElement.getAttribute("data-dependency"));if(dependencyInfo.value==dependentValue){dependentElement.classList.remove("karma-hide-controller");isHide=false}else{dependentElement.classList.add("karma-hide-controller");isHide=true}this.findDependentElements(dependentElement,isHide)},findDependentElements:function(dependentElement,isHide){var dependInput=dependentElement.querySelector("input");if(null==dependInput){return}var controller=dependentElement.querySelector("input").getAttribute("name"),dependentElements=document.querySelectorAll('[data-dependency-element="'+controller+'"]'),that=this,hide,lastElement;if(dependentElements.length){_.each(dependentElements,function(element){if(isHide||dependentElement.classList.contains("karma-hide-controller")){element.classList.add("karma-hide-controller")}else{element.classList.remove("karma-hide-controller");that.doDependency(element,dependentElement.querySelector("input").value);this.callScrollOnResize()}lastElement=element});hide=lastElement.classList.contains("karma-hide-controller")?true:false;that.findDependentElements(lastElement,hide)}},updateModel:function(event){var attributes=JSON.parse(JSON.stringify(this.model.attributes.shortcode_attributes));attributes[event.target.name]=event.target.value;attributes.changed={};attributes.changed[event.target.name]=event.target.value;this.model.set("shortcode_attributes",attributes)},scrollSettingPanel:function(){$(".karma-element-setting-panel-content").niceScroll({cursorcolor:"#A9A9A9",cursorwidth:"2px",cursoropacitymax:.56,cursorborder:"none",horizrailenabled:false})},callScrollOnResize:function(){$(".karma-element-setting-panel-content").getNiceScroll().resize()}})})(jQuery,karmaBuilderActions);