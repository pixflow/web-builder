(function($,karmaBuilder){karmaBuilder.shortcodes=karmaBuilder.elementSettingPanel.extend({events:{"mousedown > .karma-spacing-container .karma-spacing":"showMouseToolTip"},shortcodeParams:{},templateSettings:{evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"},innerGizmoTemplate:'<div class="{{ data.className }}">'+" <# _.each( data.params, function( param ){ #>"+' <div class="karma-builder-gizmo-{{ param.type }} {{ param.className }} " data-form="{{ param.form }}">'+' <# if( "icon" === param.type ){ #>'+" <div>{{{ param.icon }}}</div>"+'<# } else if( "text" === param.type ) {#>'+"<div>{{{ param.value }}}</div>"+"<# } #>"+"</div>"+"<# }) #>"+"</div>",bothSpacingGizmoTemplate:'<div class="{{ data.className }} karma-spacing-container">'+'<div class="karma-spacing karma-top-spacing ui-resizable-handle ui-resizable-s karma-top-spacing-height" data-direction="both" >'+'<div class="karma-spacing-dot-container">'+'<div class="spacing-dot"></div>'+'<div class="spacing-top-hover"><div class="spacing-dot-hover target-moving"></div></div>'+"</div>"+"</div>"+'<div class="karma-spacing karma-bottom-spacing ui-resizable-handle  ui-resizable-s" data-direction="both" style="height:{{ data.space }}px">'+'<div class="karma-spacing-dot-container">'+'<div class="spacing-dot"></div>'+'<div class="spacing-bottom-hover"><div class="spacing-dot-hover"></div></div>'+"</div>"+"</div>"+"</div>",leftSpacingGizmoTemplate:'<div class="left-resizing {{ data.className }} karma-spacing-container">'+'<div class="karma-spacing karma-left-spacing ui-resizable-handle ui-resizable-e ui-resizable-e" data-direction="left" style="width:{{ data.spaceing }}px">'+'<div class="karma-spacing-dot-container">'+'<div class="spacing-dot"></div>'+'<div class="spacing-left-hover"><div class="spacing-dot-hover target-moving"></div></div>'+"</div>"+"</div>"+"</div>",rightSpacingGizmoTemplate:'<div class="{{ data.className }} karma-spacing-container">'+'<div class="karma-spacing karma-right-spacing ui-resizable-handle ui-resizable-w ui-resizable-w" data-direction="right" style="width:{{ data.spaceing }}px">'+'<div class="karma-spacing-dot-container">'+'<div class="spacing-dot"></div>'+'<div class="spacing-right-hover"><div class="spacing-dot-hover target-moving"></div></div>'+"</div>"+"</div>"+"</div>",topSpacingGizmoTemplate:'<div class="{{ data.className }} karma-spacing-container">'+'<div class="karma-spacing karma-top-spacing ui-resizable-handle ui-resizable-s ui-resizable-n " data-direction="top" style="height:{{ data.spaceing }}px">'+'<div class="karma-spacing-dot-container">'+'<div class="spacing-dot"></div>'+'<div class="spacing-dot-hover target-moving"></div>'+"</div>"+"</div>"+"</div>",resizeGizmoTemplate:'<div class="{{data.class}}" data-snap="{{data.param.snapGrid}}" ></div>',topGizmoTemplate:'<div class="{{data.class}}">'+" <# _.each( data.params, function( param ){  #>"+' <div class="karma-builder-gizmo-{{ param.type }} {{ param.className }} " data-form="{{ param.form }}">'+' <# if( "icon" === param.type ){ #>'+" <div>{{{ param.icon }}}</div>"+'<# } else if( "text" === param.type ) {#>'+"<div>{{{ param.value }}}</div>"+'<# } else if( "icon-text" === param.type ) {#>'+'<span class="karama-gizmo-icon">{{{ param.icon }}}</span>'+'<span class="karma-gizmo-title">{{{ param.text }}} {{param.counter}}</span>'+"<# } #>"+"</div>"+"<# }) #>"+"</div>",initialize:function(options){this.template=options.template;if(this.model){_.bindAll(this,"update","destroy");this.model.bind("change",this.update);this.model.bind("destroy",this.destroy)}this.gizmoParams=options.gizmoParams;this.toolTipHtml();this.addActionTrigger()},gizmoEvents:function(gizmoParams){if("undefined"===typeof gizmoParams){return}for(var i in gizmoParams){if("undefined"!==typeof gizmoParams[i].form){var event={};event["click ."+gizmoParams[i].className]="showSettingPanel";this.delegateEvents(_.extend(this.events,event))}}},createRandomString:function(length){var characters="0123456789abcdefghijklmnopqrstuvwxyz",charactersLength=characters.length,randomString="";for(var i=0;i<length;i++){randomString+=characters[Math.floor(Math.random()*(charactersLength-1)+1)]}return randomString},getElementMap:function(elementName,form){if(this.shortcodeParams){this.shortcodeParams=JSON.parse(builderMaps)}return this.shortcodeParams[elementName][form]},getWpTemplate:function(templateName,templateParams){if(null===templateParams){templateParams={}}var tempObject=wp.template(templateName);return tempObject(templateParams)},getUnderscoreTemplate:function(templateName,params){var compiled,that=this;compiled=_.template(templateName,that.templateSettings);return compiled(params)},gizmoBuilder:function(gizmoParams){var tempName=gizmoParams.type+"Template";if("undefined"!==typeof this[tempName]){var gizmoParams=$("body").triggerHandler("before/buildGizmo",[tempName,gizmoParams]);return $(this.getUnderscoreTemplate(this[tempName],gizmoParams))}},createGizmo:function(){for(var i in this.gizmoParams){for(var param in this.gizmoParams[i].params){if(this.gizmoParams[i].params[param].hasOwnProperty("showIndex")){this.gizmoParams[i].params[param]["counter"]=this.$el.parent().find('> div[class *= "col-sm"]').index(this.$el)+1}else{this.gizmoParams[i].params[param]["counter"]=""}}var $gizmo=this.gizmoBuilder(this.gizmoParams[i]);this.$el.append($gizmo);if("function"===typeof this[this.gizmoParams[i].type.replace(/-/g,"")]){this[this.gizmoParams[i].type.replace(/-/g,"")]($gizmo)}this.gizmoEvents(this.gizmoParams[i].params)}},bothSpacingGizmo:function($gizmo){var that=this,options={maxHeight:700,minHeight:0,handles:{},scroll:true,stop:function(event,ui){that.setAttributes({space:parseInt(ui.element.height())},true)},resize:function(event,ui){var currentSection=that.el.querySelector("div:first-child");currentSection.style.paddingTop=ui.size.height+"px";currentSection.style.paddingBottom=ui.size.height+"px"}};options.handles.s=$gizmo.find(".ui-resizable-s").eq(0);options.handles.n=$gizmo.find(".ui-resizable-s").eq(1);this.$el.find(".karma-bottom-spacing").resizable(options)},topSpacingGizmo:function($gizmo){var that=this,options={maxHeight:700,minHeight:0,handles:{},stop:function(event,ui){that.setAttributes({space:parseInt(ui.element.height())},true)},resize:function(event,ui){var currentSection=that.el.querySelector("div:first-child");currentSection.style.paddingTop=ui.size.height+"px"}};options.handles.s=$gizmo.find(".ui-resizable-s");this.$el.find(".karma-top-spacing").resizable(options)},createRightLeftSpacingGizmo:function(spacingSelector,paddingDirection){var calculating=this.calculateMaxWidthSpacing(spacingSelector),maxWidth=calculating,that=this,options={maxWidth:maxWidth,minWidth:0,handles:{},stop:function(event,ui){var value=parseInt(ui.element.width())<0?0:parseInt(ui.element.width());if("padding-left"==paddingDirection){that.setAttributes({leftSpace:value},true)}else{that.setAttributes({rightSpace:value},true)}},resize:function(event,ui){var calculating=that.calculateMaxWidthSpacing(spacingSelector);ui.element.resizable("option","maxWidth",calculating);var value=ui.size.width<0?0:parseInt(ui.size.width);that.renderCss(".karma-section div.karma-column."+that.elementSelector(),paddingDirection,value+"px")}};return options},leftSpacingGizmo:function($gizmo){var that=this;var options=this.createRightLeftSpacingGizmo(".karma-right-spacing","padding-left");that.$el.attr("data-direction","left");options.handles.e=$gizmo.find(".ui-resizable-e");this.$el.find(".karma-left-spacing").resizable(options)},rightSpacingGizmo:function($gizmo){var that=this;var options=this.createRightLeftSpacingGizmo(".karma-left-spacing","padding-right");that.$el.attr("data-direction","right");options.handles.w=$gizmo.find(".ui-resizable-w");this.$el.find(".karma-right-spacing").resizable(options)},calculateMaxWidthSpacing:function(spacingGizmo){var $element=this.$el,elementWidth=$element.width(),elementSpacing=$element.find(spacingGizmo).width(),paddingValue=elementWidth-elementSpacing-10;return paddingValue},showMouseToolTip:function(e){var that=this;var tooltipDiv=document.body.querySelector(".tooltip-div");tooltipDiv.style.display="block";tooltipDiv.style.top=e.clientY+20+"px";tooltipDiv.style.left=e.clientX-20+"px";tooltipDiv.innerText="";e.target.classList.add("target-moving");var direction=$(e.target).closest(".karma-spacing").attr("data-direction");this.showMouseToolTipValue(tooltipDiv,direction);document.documentElement.addEventListener("mousemove",function(e){that.moveMouseToolTip(e,that,direction)},false);document.documentElement.addEventListener("mouseup",this.removeMouseToolTip,false)},moveMouseToolTip:function(e,that,direction){var tooltipDiv=document.body.querySelector(".tooltip-div");if("none"===tooltipDiv.style.display){return false}var x=e.clientX,y=e.clientY;tooltipDiv.style.top=y+20+"px";tooltipDiv.style.left=x-20+"px";that.showMouseToolTipValue(tooltipDiv,direction)},showMouseToolTipValue:function(tooltipDiv,direction){switch(direction){case"left":tooltipDiv.innerText=this.$el.find("> .karma-spacing-container .karma-spacing.karma-left-spacing").width()+" px";break;case"right":tooltipDiv.innerText=this.$el.find("> .karma-spacing-container .karma-spacing.karma-right-spacing").width()+" px";break;case"both":tooltipDiv.innerText=this.$el.find("> .karma-spacing-container .karma-spacing.karma-bottom-spacing").height()+" px";break;case"top":tooltipDiv.innerText=this.$el.find("> .karma-spacing-container .karma-spacing").height()+" px";break}},removeMouseToolTip:function(e){var tooltipDiv=document.body.querySelector(".tooltip-div");tooltipDiv.style.display="none";e.target.classList.remove("target-moving");document.documentElement.removeEventListener("mousemove",this.moveMouseToolTip);document.documentElement.removeEventListener("mouseup",this.removeMouseToolTip)},toolTipHtml:function(){if(!document.querySelectorAll(".tooltip-div").length){var tooltip=document.createElement("div");tooltip.setAttribute("class","tooltip-div");document.body.appendChild(tooltip)}},createNewElementKey:function(){var randomString="kb"+this.createRandomString(6);if(karmaBuilder.karmaModels.where({element_key:randomString}).length){return this.createNewElementKey()}return randomString},update:function(model){for(var i in model.changed.shortcode_attributes.changed){if("function"===typeof this[i]){this[i]()}else{this.render()}}},render:function(){this.el.innerHTML=this.template(this.model);$("body").trigger("karma_finish_render_html",[this.model]);return true},destroy:function(){this.$el.find(".karma-builder-element").each(function(){var childKey=$(this).attr("data-element-key");karmaBuilder.karmaModels.remove(karmaBuilder.karmaModels.where({element_key:childKey}))});this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},setAttributes:function(newAttributes,silent){var model=this.model,shortcodeAtrributes=JSON.parse(JSON.stringify(model.attributes.shortcode_attributes));shortcodeAtrributes.changed={};for(var attr in newAttributes){shortcodeAtrributes[attr]=newAttributes[attr];shortcodeAtrributes.changed[attr]=newAttributes[attr]}model.set({shortcode_attributes:shortcodeAtrributes},{silent:silent})},getAttributes:function(attributesNames){var model=this.model,shortcodeAtrributes=model.attributes.shortcode_attributes,attributeValue={};for(var attr in attributesNames){if(shortcodeAtrributes[attributesNames[attr]]){attributeValue[attributesNames[attr]]=shortcodeAtrributes[attributesNames[attr]]}}return attributeValue},findChildren:function(){return karmaBuilder.karmaModels.where({parent_key:this.model.attributes["element_key"]})},showSettingPanel:function(e){var form=$(e.currentTarget).data("form");this.openSettingPanel(this.model,form);window.builder=new karmaBuilder.elementSettingPanel({model:this.model});builder.delegateEvents()},removeClass:function(el,className){if(this.el.classList){this.el.classList.remove(className)}else{this.el.className=this.el.className.replace(new RegExp("(^|\\b)"+className.split(" ").join("|")+"(\\b|$)","gi")," ")}},elementSelector:function(){return this.el.getAttribute("data-name").replace("_","-")+"-"+this.el.getAttribute("data-element-key")},renderCss:function(selector,attribute,value){document.querySelector("#style-"+this.elementSelector()).innerHTML=this.generateNewStyle(selector,attribute,value)},generateNewStyle:function(selector,attribute,value){var style=document.getElementById("style-"+this.elementSelector()).innerHTML,styleResult=style.split(/[{}]+/),newStyle="";if(style.indexOf(selector)<0){newStyle=style+selector+"{"+attribute+":"+value+";}";return newStyle}for(var i=0;i<styleResult.length;i++){if(i%2==1||""==styleResult[i])continue;if(selector==styleResult[i].replace(/^\s+|\s+$/g,"")){newStyle+=styleResult[i]+"{";newStyle+=this.generateStyleString(styleResult[i+1],attribute,value)}else{newStyle+=styleResult[i]+"{"+styleResult[i+1]+"}"}}return newStyle},generateStyleString:function(styleResult,attribute,value){var newStyle="";if(styleResult.indexOf(attribute)>=0){var regex=new RegExp(attribute+":([0-9]*[a-z])*;");newStyle+=styleResult.replace(regex,attribute+":"+value+";");newStyle+="}"}else{newStyle+=styleResult+attribute+":"+value+";}"}return newStyle},createNewElement:function(elementName,model){if("undefined"!==typeof karmaBuilder[elementName]){$('[data-element-key="'+model.attributes.parent_key+'"]').find(".karma-row").append(this.createBuilderModel(model));var elementView=new karmaBuilder[elementName]({model:model,gizmoParams:KarmaView.getGizmoParam(model.attributes.shortcode_name),el:$('[data-element-key="'+model.attributes.element_key+'"]'),template:wp.template("karma-element-"+model.attributes.shortcode_name)});elementView.render()}},createBuilderModel:function(model){model=model?model:this.model;var classes=$(document).triggerHandler("before/elements/create/"+model.attributes.shortcode_name,[model.attributes.shortcode_attributes]),elementKey=model.attributes.element_key,elementName=model.attributes.shortcode_name,karmaBuilderOutput,tags;classes+=" "+elementName.replace("_","-")+"-"+elementKey;karmaBuilderOutput='<div class="karma-builder-element '+classes+'" data-element-key="'+elementKey+'" data-name="'+elementName+'" > '+"</div>",tags='<style id="style-'+elementName.replace("_","-")+"-"+elementKey+'" ></style>'+'<script  id="script-'+elementName.replace("_","-")+"-"+elementKey+'" ><\/script>';return tags+karmaBuilderOutput},addActionTrigger:function(){$(document).off("before/elements/create/karma_column").on("before/elements/create/karma_column",function(e,atts){var classes="karma-col-sm-"+atts["sm_size"]+" karma-col-md-"+atts["md_size"]+" karma-col-lg-"+atts["lg_size"]+" karma-col-xl-"+atts["xl_size"];return classes})}});karmaBuilder.shortcodes.extend=function(child){var view=Backbone.View.extend.apply(this,arguments);if(true===child.denyEvents){return view}view.prototype.events=_.extend({},this.prototype.events,child.events);return view}})(jQuery,karmaBuilder);