var karmaBuilder=karmaBuilder||{};(function($,karmaBuilder){"use strict";karmaBuilder.view=Backbone.View.extend({gizmoParams:{},events:{},initialize:function(){this.gizmoParams=JSON.parse(builderGizmo);this.render()},render:function(){var that=this;this.collection.each(function(element){var elementName=element.attributes.shortcode_name.replace("karma_","");var elementView=new karmaBuilder[elementName]({model:element,el:$('[data-element-key="'+element.attributes.shortcode_attributes.element_key+'"]'),gimzoParams:that.gizmoParams[element.attributes.shortcode_name],template:wp.template("karma-element-"+element.attributes.shortcode_name)});elementView.createGizmo();elementView.delegateEvents()})},prepareAjax:function(){return $.ajax({type:"post",url:ajaxurl,action:"save_content",data:{models:JSON.stringify(karmaBuilder.karmaModels),id:$('meta[name="post-id"]').attr("content")}})},saveContent:function(){this.prepareAjax().done(function(response){var result=JSON.parse(response);if(true===result.result){return true}else{return false}})},dragElement:function(){},dropElement:function(droppedElement,placeHolder){}});karmaBuilder.shortcodes=Backbone.View.extend({shortcodeParams:{},templateSettings:{evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"},innerGizmoTemplate:'<div class="{{ data.className }}">'+" <# _.each( data.params, function( param ){ #>"+' <div class="karma-builder-gizmo-{{ param.type }} {{ param.className }} ">'+' <# if( "icon" === param.type ){ #>'+" <div>{{{ param.icon }}}</div>"+'<# } else if( "text" === param.type ) {#>'+"<div>{{{ param.value }}}</div>"+"<# } #>"+"</div>"+"<# }) #>"+"</div>",events:{"click .karma-element-setting":"showSettingPanel"},initialize:function(options){this.template=options.template;if(this.model){_.bindAll(this,"render","destroy");this.model.bind("change",this.render);this.model.bind("destroy",this.destroy)}},createRandomString:function(length){var characters="0123456789abcdefghijklmnopqrstuvwxyz",charactersLength=characters.length,randomString="";for(var i=0;i<length;i++){randomString+=characters[Math.floor(Math.random()*(charactersLength-1)+1)]}return randomString},getElementMap:function(elementName){if(this.shortcodeParams){this.shortcodeParams=JSON.parse(builderMaps)}return this.shortcodeParams[elementName]},getWpTemplate:function(templateName,templateParams){if(null===templateParams){templateParams={}}var tempObject=wp.template(templateName),tempHtml=tempObject(templateParams);return tempHtml},getUnderscoreTemplate:function(templateName,params){var compiled,that=this;compiled=_.template(templateName,that.templateSettings);return compiled(params)},gizmoBuilder:function(gizmoParams){switch(gizmoParams.type){case"inner-gizmo":return this.getUnderscoreTemplate(this.innerGizmoTemplate,gizmoParams);break;case"top-gizmo":break;case"over-gizmo":break;default:return false;break}},createNewElementKey:function(){var randomString=this.createRandomString(6);if(karmaBuilder.karmaModels.where({element_key:randomString}).length){return this.createNewElementKey()}return randomString},update:function(element){var children,elementId=$(element).attr("data-element-id");if($(element).children().length){children=$(element).children().clone(true)}this.el.innerHTML=this.template(this.model);$(this.el).find('*[data-element-id="'+elementId+'"]').append(children);$("body").trigger("finish_update_html",[this.model]);return true},render:function(){this.el.innerHTML=this.template(this.model);$("body").trigger("karma_finish_render_html",[this.model]);return true},destroy:function(){this.$el.find(".karma-builder-element").each(function(){var childId=$(this).attr("data-element-id");karmaBuilder.karmaModels.remove(karmaBuilder.karmaModels.where({shortcode_id:parseInt(childId)}))});this.undelegateEvents();this.$el.removeData().unbind();this.remove();Backbone.View.prototype.remove.call(this)},setAttributes:function(newAttributes,silent){var model=this.model,shortcodeAtrributes=model.attributes.shortcode_attributes;for(var attr in newAttributes){shortcodeAtrributes[attr]=newAttributes[attr]}model.set({shortcode_attributes:shortcodeAtrributes},{silent:silent})},updateShortcode:function(newAttributes){this.setAttributes(newAttributes,false);this.update(document.querySelector('*[data-element-id="'+model.attributes.shortcode_id+'"]'));return karmaBuilder.karmaModels},findChildren:function(){return karmaBuilder.karmaModels.where({parent_id:this.model.attributes["shortcode_id"]})},showSettingPanel:function(){window.builder=new karmaBuilder.elementSettingPanel({el:jQuery("body"),model:this.model});builder.delegateEvents()}});karmaBuilder.shortcodes.extend=function(child){var view=Backbone.View.extend.apply(this,arguments);if(true===child.denyEvents){return view}view.prototype.events=_.extend({},this.prototype.events,child.events);return view};karmaBuilder.elementSettingPanel=karmaBuilder.shortcodes.extend({denyEvents:true,events:{"click .karma-setting-panel-close-svg":"removeSettingPanel","click .delete-karma-element":"removeElement","input input,textarea":"updateModel"},initialize:function(options){this.options=options;this.render()},render:function(){this.openSettingPanel(this.options.model);this.bindDragEvents()},bindDragEvents:function(){$("#karma-element-setting-panel-container").draggable({containment:"body",scroll:true,scrollSpeed:100,distance:10,cancel:".karma-shortcode-setting-panel-extra, input"})},removeElement:function(){if(!confirm("are you sure?"))return;this.model.destroy();this.removeSettingPanel()},openSettingPanel:function(model){var template=wp.template("karma-element-setting-panel"),$html=document.createElement("div"),content=this.formBuilder(model),elementAttributes=model.attributes,elementName=elementAttributes["shortcode_name"].replace("karma_",""),elementSelector=elementAttributes["shortcode_name"]+"_"+elementAttributes.shortcode_attributes["element_key"];$html.innerHTML=template({headerTitle:elementName+" Setting",content:content,selector:elementSelector});document.getElementById("page").appendChild($html);this.bindDragEvents();$("body").trigger("karma_finish_form_builder")},formBuilder:function(model){var shortcodeModel=model.attributes,ShortcodeParams=this.getElementMap(shortcodeModel.shortcode_name),karmaformhtml='<form id="karma-Builder-form"  autocomplete="off" onsubmit="return false">',groupHtml="",groupHtml_group=[],setting_panel_group="";ShortcodeParams=this.updateElementParams(shortcodeModel,ShortcodeParams);for(var counter in ShortcodeParams.params){if(!ShortcodeParams.params[counter].group){groupHtml+=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",ShortcodeParams.params[counter])}else{if(undefined===groupHtml_group[ShortcodeParams.params[counter].group]){groupHtml_group[ShortcodeParams.params[counter].group]={items:[],title:ShortcodeParams.params[counter].group}}var html=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",ShortcodeParams.params[counter]);groupHtml_group[ShortcodeParams.params[counter].group]["items"].push(html)}}for(var counter in groupHtml_group){setting_panel_group+=this.getWpTemplate("karma-setting-panel-groups-extend",groupHtml_group[counter])}karmaformhtml+='<div id="elementRow" >'+groupHtml+"</div>";var popup=document.createElement("div");popup.innerHTML=karmaformhtml+setting_panel_group;return popup.innerHTML},removeSettingPanel:function(){var settingPanel=document.querySelector("#karma-element-setting-panel-container");settingPanel.parentNode.removeChild(settingPanel)},updateElementParams:function(model,elementParam){for(var index in elementParam.params){var paramName=elementParam.params[index].name;if(undefined!==model.shortcode_attributes[paramName]){elementParam.params[index].value=model.shortcode_attributes[paramName]}}return elementParam}});karmaBuilder.model=Backbone.Model.extend({defaults:{shortcode_name:"karma_row",shortcode_attributes:{element_key:"",padding:"200"},shortcode_content:"",shortcode_id:1,order:1,parent_id:0}});var KarmaShortcodesCollection=Backbone.Collection.extend({model:karmaBuilder.model});$(document).ready(function(){karmaBuilder.karmaModels=new KarmaShortcodesCollection(JSON.parse(builderModels));var KarmaView=new karmaBuilder.view({collection:karmaBuilder.karmaModels})})})(jQuery,karmaBuilder);