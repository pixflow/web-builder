var karmaBuilder=karmaBuilder||{};(function($,karmaBuilder){"use strict";karmaBuilder.view=Backbone.View.extend({gizmoParams:{},builderParams:{},flyScroll:"",elementInfo:{},templateSettings:{evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"},events:{"click.bindDocumentEvent":"bindDocumentEvent","karma/before/publish":"karmaPublish","karma/before/elements/create/karma_column":"createElementAction","karma/before/save":"karmaSaved","karma/after/dropElement.reorderElements":"reorderElements","karma/after/dropElement.emptyColumn":"removeEmptyColumn","karma/after/finishElementPanel":"makeElementsDraggable","click .karma-blank-page-simple-layout .karma-new-section-layout":"createNewSection","click .karma-blank-page-section-link":"openSectionPanel","karma/callParent":"callParent"},initialize:function(){this.notifyDevelopers()},notifyDevelopers:function(){console.log("%c      ","font-size:80px; background: url("+this.getBuilderParam("alertIconUrl")+") no-repeat;");console.log("%c Please dont modify Karmabuilder models and save it, it can destroy your content! ","background: #cc1526; color: #BFF8F8")},getBuilderParam:function(name){if(0===Object.keys(this.builderParams).length){this.builderParams=JSON.parse(builderParams)}return this.builderParams[name]},getGizmoParam:function(name){if(0===Object.keys(this.gizmoParams).length){this.gizmoParams=JSON.parse(builderGizmo)}return this.gizmoParams[name]},render:function(){var that=this;this.makeSectionsSortable();that.collection.each(function(element){var elementName=element.attributes.shortcode_name.replace("karma_","");elementName=elementName.replace(/_/g,"");if("undefined"!==typeof karmaBuilder[elementName]){var elementView=new karmaBuilder[elementName]({model:element,el:$('[data-element-key="'+element.attributes.element_key+'"]'),gizmoParams:that.getGizmoParam(element.attributes.shortcode_name),template:wp.template("karma-element-"+element.attributes.shortcode_name)});elementView.renderSettings()}});this.bindDocumentEvent()},callParent:function(event,element,functions,deep){var parentInstance=$(element).closest('.karma-builder-element[data-name="'+(deep==1?"karma_column":"karma_section")+'"]').backboneView();_.each(functions,function(callback){parentInstance[callback](event)})},createNewSection:function(e){var domNode=e.target.closest(".karma-new-section-layout"),newGrid=JSON.parse(domNode.getAttribute("data-value")),placeholder=document.getElementById("karma-builder-layout"),elementName="karma_section",validateModel=KarmaView.getValidateElementModel(placeholder,elementName),model=karmaBuilder.karmaModels.add(validateModel);placeholder.innerHTML=KarmaView.createBuilderModel(model);var newSection=KarmaView.createNewElement(elementName.replace("karma_",""),model,true);newSection.changeRowLayout(newGrid);KarmaView.createStyleSheetForElements(newSection.model.attributes.shortcode_attributes,newSection);newSection.$el.click()},openSectionPanel:function(e){e.stopPropagation();var elementPanel=window.top.document.querySelector(".karma-element-panel-add-element-view");if(null!=elementPanel){elementPanel.classList.add("element-panel-show")}var elementPanelSection=window.top.document.querySelector(".element-panel-section");if(null!=elementPanelSection){elementPanelSection.classList.add("karma-active-tab")}var elementPanelSectionActiveButton=window.top.document.querySelector('.karma-addcontent[data-tab="karma-element-panel-list"]');if(null!=elementPanelSectionActiveButton){elementPanelSectionActiveButton.classList.remove("karma-addcontent-active")}var elementPanelSectionButton=window.top.document.querySelector('.karma-addcontent[data-tab="element-panel-section"]');if(null!=elementPanelSectionButton){elementPanelSectionButton.classList.add("karma-addcontent-active")}},bindDocumentEvent:function(){this.removeActiveElement();this.removeActiveColumn();this.removeActiveSection();this.removeSettingPanel();this.closeElementPanel()},removeActiveElement:function(){var activeElement=document.querySelector(".karma-active-element");if(null!=activeElement){activeElement.classList.remove("karma-active-element")}$(document).trigger("click.hideColorPickerContainer");return this},removeActiveColumn:function(){var activeElement=document.querySelector(".karma-active-column");if(null!=activeElement){activeElement.classList.remove("karma-active-column")}return this},removeSettingPanel:function(){if("undefined"!=typeof elementSettingPanel){elementSettingPanel.removeSettingPanel()}return this},closeElementPanel:function(){if("undefined"!=typeof window.top.karmaElementPanel){window.top.karmaElementPanel.closeElementPanel()}return this},removeActiveSection:function(){var activeElement=document.querySelector(".karma-active-section");if(null!=activeElement){activeElement.classList.remove("karma-active-section")}return this},prepareAjax:function(action,data){var that=this;return $.ajax({type:"post",url:that.getBuilderParam("ajaxUrl"),data:data})},karmaPublish:function(){var that=this,data={models:that.prepareModels(),id:$('meta[name="post-id"]').attr("content"),action:"publish"};this.prepareAjax("publish",data).done(function(response){var result=JSON.parse(response);window.top.karmaBuilderEnviroment.$el.trigger("karma/finish/animation");return result.result})},karmaSaved:function(){var that=this,data={models:that.prepareModels(),id:$('meta[name="post-id"]').attr("content"),action:"save"};this.prepareAjax("save",data).done(function(response){var result=JSON.parse(response);return result.result})},prepareModels:function(){var models=JSON.parse(JSON.stringify(karmaBuilder.karmaModels));_.each(models,function(model){if(undefined!=model.shortcode_attributes.changed){delete model.shortcode_attributes.changed}});return JSON.stringify(models)},createNewElementKey:function(){var randomString="kb"+this.createRandomString(6);if(karmaBuilder.karmaModels.where({element_key:randomString}).length){return this.createNewElementKey()}return randomString},createRandomString:function(length){var characters="0123456789abcdefghijklmnopqrstuvwxyz",charactersLength=characters.length,randomString="";for(var i=0;i<length;i++){randomString+=characters[Math.floor(Math.random()*(charactersLength-1)+1)]}return randomString},createNewElement:function(elementName,model,shouldRender){elementName=elementName.replace(/_/g,"");if("undefined"!==typeof karmaBuilder[elementName]){shouldRender=shouldRender?shouldRender:true;var elementView=new karmaBuilder[elementName]({model:model,gizmoParams:KarmaView.getGizmoParam(model.attributes.shortcode_name),el:$('[data-element-key="'+model.attributes.element_key+'"]'),template:wp.template("karma-element-"+model.attributes.shortcode_name),renderStatus:shouldRender});elementView.renderSettings()}return elementView},createBuilderModel:function(model){model=model?model:this.model;var classes=this.$el.triggerHandler("karma/before/elements/create/"+model.attributes.shortcode_name,[model.attributes.shortcode_attributes]),elementKey=model.attributes.element_key,elementName=model.attributes.shortcode_name,karmaBuilderOutput,alignmentClass="",tags,output="",id=elementName.replace(/_/g,"-")+"-"+elementKey;classes=classes?classes+" "+elementName.replace(/_/g,"-")+"-"+elementKey:elementName.replace(/_/g,"-")+"-"+elementKey;tags='<style id="style-'+elementName.replace(/_/g,"-")+"-"+elementKey+'" >'+"</style>"+'<script  id="script-'+elementName.replace(/_/g,"-")+"-"+elementKey+'" ><\/script>';if("karma_column"!=elementName&&"karma_section"!=elementName){output='<div class="karma-element-content"></div>';alignmentClass=" karma-element-alignment-left "}karmaBuilderOutput='<div id="'+id+'" class="karma-builder-element '+alignmentClass+classes+'" data-element-key="'+elementKey+'" data-name="'+elementName+'" > '+output+"</div>";return tags+karmaBuilderOutput},createElementAction:function(e,atts){var classes="karma-col-sm-"+atts["sm_size"]+" karma-col-md-"+atts["md_size"]+" karma-col-lg-"+atts["lg_size"]+" karma-col-xl-"+atts["xl_size"];return classes},getWpTemplate:function(templateName,templateParams,deep){if(null===templateParams){templateParams={}}if(1==deep){var tempObject=window.top.wp.template(templateName)}else{var tempObject=wp.template(templateName)}return tempObject(templateParams)},getUnderscoreTemplate:function(templateName,params){var compiled,that=this;compiled=_.template(templateName,that.templateSettings);return compiled(params)},prepareBeforeDrop:function(whereToDrop,elementName,type){if(null==whereToDrop){return false}var validateModel=this.getValidateElementModel(whereToDrop,elementName,type),model=karmaBuilder.karmaModels.add(validateModel);whereToDrop.outerHTML=KarmaView.createBuilderModel(model);elementName=elementName.replace(/_/g,"");KarmaView.createNewElement(elementName.replace("karma",""),model,true);this.$el.trigger("karma/after/dropElement",[validateModel["parent_key"]])},getValidateElementModel:function(whereToDrop,elementName,type){var parentKey=whereToDrop.closest(".karma-builder-element"),modelAttributes=$(document).triggerHandler("karma/before/createElement/"+elementName);if("karma_unsplash_image"==type){var imageUrl=window.top.document.querySelector(".ui-draggable-dragging").getAttribute("data-full-url");modelAttributes.imgurl=imageUrl}return{order:1,element_key:KarmaView.createNewElementKey(),shortcode_name:elementName,shortcode_content:"",shortcode_attributes:modelAttributes,parent_key:null==parentKey?"":parentKey.getAttribute("data-element-key")}},newModelAttributes:function(element,modelAttributes){if("karma_unsplash_image"==element){var imageUrl=document.querySelector(".ui-draggable-dragging").getAttribute("data-full-url");modelAttributes.imgurl=imageUrl;return modelAttributes}return modelAttributes},reorderElements:function(e,parentKey){var childElements=document.querySelectorAll('[data-element-key="'+parentKey+'"] .karma-builder-element'),order=1;_.each(childElements,function(element){var elementInstance=$(element).backboneView();elementInstance.model.attributes.order=order;order++})},removeEmptyColumn:function(e,parentKey){var parentSection=document.querySelector('[data-element-key="'+parentKey+'"]').closest(".karma-section");$(parentSection).find(".karma-empty-column").removeClass("karma-empty-column")},scroll:function(element,event){var element=element.helper,toolbarHeight=150;this.scrollToDown(element,toolbarHeight,event);this.scrollToTop(element,event)},keepElementPosition:function(element,direction){var elementNode=element[0],top=parseInt(elementNode.style.top);top="up"===direction?top-5:top+5;elementNode.style.top=top+"px"},scrollToDown:function(element,toolbarHeight,event){var that=this;if(event.clientY+toolbarHeight>window.innerHeight){clearInterval(that.flyScroll);that.flyScroll=setInterval(function(){if(window.innerHeight+window.scrollY>=document.body.offsetHeight){clearInterval(that.flyScroll)}that.keepElementPosition(element,"down");$(window).scrollTop($(window).scrollTop()+5)},1)}else{clearInterval(that.flyScroll)}},scrollToTop:function(element,event){var that=this;if(event.clientY<50){clearInterval(that.flyScroll);that.flyScroll=setInterval(function(){if($(window).scrollTop()==0){clearInterval(that.flyScroll)}that.keepElementPosition(element,"up");$(window).scrollTop($(window).scrollTop()-5)},1)}},getParentElementInfo:function(element){var parentElement=element.closest(".karma-builder-element");if(null==parentElement){return false}var elementName=parentElement.getAttribute("data-name"),info={node:parentElement,name:elementName};return info},overlayBehavior:function(event,UI){if(UI.helper.hasClass("karma-element-single-element")||UI.helper.hasClass("karma-unsplash-images-list")){var overlay=window.top.document.querySelector(".karma-overlay-on-dragging")}else{var overlay=document.querySelector(".karma-overlay-on-dragging")}overlay.style.display="none";UI.helper.get(0).style.display="none";var targetElement=document.elementFromPoint(event.clientX,event.clientY);if(undefined==targetElement){return false}else if(targetElement.classList.contains("karma-spacing")){targetElement=document.elementFromPoint(event.clientX,event.clientY+50)}else if(targetElement.classList.contains("karma-section")){targetElement=document.elementFromPoint(event.clientX-50,event.clientY)}overlay.style.display="block";UI.helper.get(0).style.display="flex";return targetElement},removePlaceHolders:function(){var activePlaceHolder=document.querySelector(".karma-show-placeholder");if(null!=activePlaceHolder){activePlaceHolder.classList.remove("karma-show-placeholder")}},detectDropAreas:function(event,UI){var targetElement=this.overlayBehavior(event,UI);if(null==targetElement||false==targetElement){return false}if(targetElement.classList.contains("karma-element-placeholder")||null!=targetElement.closest(".karma-element-placeholder")){return false}targetElement=this.getParentElementInfo(targetElement);this.removePlaceHolders();if(false==targetElement||"karma_section"==targetElement.name){return false}else if(true==this.checkSelfPlaceholder(targetElement,UI)){if(targetElement.node.clientWidth==targetElement.node.querySelector(".karma-element-content").clientWidth){return false}this.setAlignment(targetElement,event)}else if("karma_column"==targetElement.name){var placeHolder=targetElement.node.querySelector(".karma-column-placeholder");if(null!=placeHolder){placeHolder.classList.add("karma-show-placeholder")}else{placeHolder=targetElement.node.querySelector(".karma-column-margin").lastChild;placeHolder.classList.add("karma-show-placeholder")}}else{this.showElementsPlaceHolder(event,targetElement)}return true},setAlignment:function(target,event){var alignPlaceholder=target.node.querySelector(".karma-alignment-placeholder"),overlay=document.querySelector(".karma-overlay-on-dragging");if(undefined!=alignPlaceholder){alignPlaceholder.classList.add("karma-show-placeholder");overlay.style.display="none";var directPlaceholder=document.elementFromPoint(event.clientX,event.clientY);overlay.style.display="block";if(undefined!=target.node.querySelector(".karma-active-align")){target.node.querySelector(".karma-active-align").classList.remove("karma-active-align")}directPlaceholder.classList.add("karma-active-align")}},checkSelfPlaceholder:function(targetElement,helperOBJ){var draggableElement=helperOBJ.helper[0].getAttribute("data-element-key"),dropareaElement=targetElement.node.getAttribute("data-element-key");if(draggableElement===dropareaElement){return true}return false},showElementsPlaceHolder:function(event,targetElement){var scrollTop=document.body.scrollTop,topPosition=targetElement.node.getBoundingClientRect().top+scrollTop,elementHeight=targetElement.node.offsetHeight,elementHalf=topPosition+elementHeight/2;if(event.clientY+scrollTop<elementHalf){targetElement.node.previousElementSibling.classList.add("karma-show-placeholder")}else{targetElement.node.nextElementSibling.classList.add("karma-show-placeholder")}},createOverlay:function(){var overlay=document.querySelector(".karma-overlay-on-dragging");if(null==overlay){overlay=document.createElement("div");overlay.classList.add("karma-overlay-on-dragging");document.body.appendChild(overlay)}else{overlay.style.display="block"}},removeOverlay:function(){var overlay=document.querySelector(".karma-overlay-on-dragging");overlay.style.display="none"},makeSectionsSortable:function(){var that=this;var oldMouseStart=$.ui.sortable.prototype._mouseStart;$.ui.sortable.prototype._mouseStart=function(event,overrideHandle,noActivation){this._trigger("beforeStart",event,this._uiHash());oldMouseStart.apply(this,[event,overrideHandle,noActivation])};$("#karma-builder-layout").sortable({cursor:"move",delay:100,cancel:".karma-active-element",items:".karma-builder-element[data-name='karma_section']",update:function(){that.reorderSections()},beforeStart:function(){document.body.style.overflowX="hidden"},sort:function(event,UI){that.scroll(UI,event)},beforeStop:function(){document.body.style.overflowX=""},stop:function(){clearInterval(that.flyScroll)}})},renderElementsChildes:function(elementsModel,elementView){var that=this,placeholder=that.getPlaceholder(elementView);this.renderElements(placeholder,elementsModel,elementView)},getPlaceholder:function(elementView){var placeholder=elementView.el.nextElementSibling;while(placeholder){if(placeholder.classList.contains("karma-element-placeholder")){placeholder=placeholder;break}placeholder=placeholder.nextElementSibling}return placeholder},renderElements:function(placeholder,elementModel,elementView){elementModel.parent.element_key=this.createNewElementKey();elementModel.parent.order=1;var newBackboneModel=karmaBuilder.karmaModels.add(elementModel.parent),elementName=newBackboneModel.get("shortcode_name").replace("karma_","");if("section"==elementName){placeholder.insertAdjacentHTML("afterend",this.createBuilderModel(newBackboneModel));var newView=this.createNewElement(elementName,newBackboneModel,true),oldGrid=elementView.currentGrid();newView.changeRowLayout(oldGrid);this.reorderSections();this.createColumnsChild(elementModel.childes,newView);newView.checkIfColumnsEmpty(newView.el.querySelector(".karma-section"))}else if("section"!=elementName&&"column"!=elementName){placeholder.insertAdjacentHTML("afterend",this.createBuilderModel(newBackboneModel));var newView=this.createNewElement(elementName,newBackboneModel,true);this.$el.trigger("karma/after/dropElement",[newBackboneModel.get("parent_key")])}this.createStyleSheetForElements(newView.model.attributes.shortcode_attributes,newView)},createStyleSheetForElements:function(models,elementView){_.each(models,function(value,model){if("function"==typeof elementView[model]){elementView[model]()}})},sortChildren:function(children){var childes=[];_.each(children,function(element){childes.push(element.parent)});childes=_.sortBy(childes,"order");return childes},preventFromScrollingOnParent:function(selector){var mouseWheelEvent=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";selector.on(mouseWheelEvent,function(e){var event=e.originalEvent,direction=event.wheelDelta||-event.detail;this.scrollTop+=(direction<0?1:-1)*30;e.preventDefault()})},createColumnsChild:function(columns,newView){var that=this,columnsInSection=newView.el.querySelectorAll(".karma-builder-element"),index=0;_.each(columns,function(column){var parentKey=columnsInSection[index].getAttribute("data-element-key"),columnChildren=that.sortChildren(column.childes);_.each(columnChildren,function(element){var placeholder=columnsInSection[index].querySelector(".karma-column-placeholder");if(null==placeholder){var elementPlaceholders=columnsInSection[index].querySelectorAll(".karma-insert-between-elements-placeholder");placeholder=elementPlaceholders[elementPlaceholders.length-1]}element.element_key=that.createNewElementKey();element.order=1;element.parent_key=parentKey;var newBackboneModel=karmaBuilder.karmaModels.add(element),elementName=newBackboneModel.get("shortcode_name").replace("karma_","");placeholder.outerHTML=that.createBuilderModel(newBackboneModel);var elementView=that.createNewElement(elementName,newBackboneModel,true);that.createStyleSheetForElements(elementView.model.attributes.shortcode_attributes,elementView)});that.$el.trigger("karma/after/dropElement",parentKey);index++})},reorderSections:function(){var childElements=document.querySelectorAll('#karma-builder-layout .karma-builder-element[data-name="karma_section"]'),order=1;_.each(childElements,function(element){var elementInstance=$(element).backboneView();elementInstance.model.attributes.order=order;order++})}});karmaBuilder.model=Backbone.Model.extend({defaults:{shortcode_name:"karma_section",shortcode_attributes:{},shortcode_content:"",element_key:"defaultKey",order:1,parent_key:"defaultParentKey"}});var KarmaShortcodesCollection=Backbone.Collection.extend({model:karmaBuilder.model});$(document).ready(function(){karmaBuilder.karmaModels=new KarmaShortcodesCollection(JSON.parse(builderModels));window.KarmaView=new karmaBuilder.view({collection:karmaBuilder.karmaModels,el:$(document)});KarmaView.render();window.top.karmaBuilderEnviroment.$el.trigger("karma/finish/iframeInit")})})(jQuery,karmaBuilder);(function($){var backboneSetElementOriginal=Backbone.View.prototype.setElement;Backbone.View.prototype.setElement=function(element){if(this.el!=element){$(this.el).backboneView("unlink")}$(element).backboneView(this);return backboneSetElementOriginal.apply(this,arguments)};$.expr[":"].backboneView=function(element,intStackIndex,arrProperties,arrNodeStack){return $(element).data("backboneView")!==undefined};var registerViewToElement=function($el,view){$el.data("backboneView",view)};var getClosestViewFromElement=function($el,viewType){var ret=null;viewType=viewType||Backbone.View;while($el.length){$el=$el.closest(":backboneView");ret=$el.length?$el.data("backboneView"):null;if(ret instanceof viewType){break}else{$el=$el.parent()}}return ret};var methods={unlink:function($el){$el.removeData("backboneView")}};$.fn.backboneView=function(){var ret=this;var args=Array.prototype.slice.call(arguments,0);if($.isFunction(methods[args[0]])){methods[args[0]](this)}else if(args[0]&&args[0]instanceof Backbone.View){registerViewToElement(this.first(),args[0])}else{ret=getClosestViewFromElement(this.first(),args[0])}return ret}})(jQuery);