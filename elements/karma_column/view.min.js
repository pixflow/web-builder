(function($,karmaBuilder){karmaBuilder.column=karmaBuilder.shortcodes.extend({events:{click:"activeColumn","click.closeExtraPanel":"closeExtraPanel","karma/finish/modifyColumns.karmaImage":"updateImageSize"},initialize:function(options){karmaBuilder.column.__super__.initialize.apply(this,arguments);this.options=options;if(this.options.renderStatus){this.render()}this.liveChangeGrid();this.checkEmptyColumn()},checkEmptyColumn:function(){var parentSection=$('[data-element-key="'+this.model.get("parent_key")+'"]').backboneView();parentSection.checkEmptyColumn()},render:function(){var source=this.template(this.model);this.el.innerHTML=source},updateImageSize:function(){var imageLinks=this.el.querySelectorAll('.karma-builder-element[data-name="karma_image"]');_.each(imageLinks,function(image){var trueWidth=image.offsetWidth;if(trueWidth<image.querySelector("img").offsetWidth){image.querySelector(".karma-image-resize").style.width=trueWidth+"px";image.querySelector(".karma-image-resize-crop").style.width=trueWidth+"px";$(image).backboneView().setAttributes({width:trueWidth},true)}})},closeExtraPanel:function(){KarmaView.removeSettingPanel().closeElementPanel().removeActiveElement()},activeColumn:function(e){e.stopPropagation();if(this.$el.hasClass("karma-active-column")){return}$(".karma-active-column").removeClass("karma-active-column");this.$el.addClass("karma-active-column");KarmaView.$el.trigger("karma/callParent",[this.el,["showBorder"],2]);if(null==this.el.querySelector(".karma-builder-element")){this.$el.trigger("karma/after/clickElement")}},rightspace:function(){var elementId=this.el.getAttribute("data-name").replace("_","-")+"-"+this.el.getAttribute("data-element-key"),padding=this.model.attributes.shortcode_attributes.rightspace+"px";this.$el.trigger("karma/finish/modifyColumns");this.renderCss(".karma-no-gutters > #"+elementId+"> .karma-column","padding-right",padding);this.el.querySelector(".karma-right-spacing").style.width=padding},leftspace:function(){var elementId=this.el.getAttribute("data-name").replace("_","-")+"-"+this.el.getAttribute("data-element-key"),padding=this.model.attributes.shortcode_attributes.leftspace+"px";this.$el.trigger("karma/finish/modifyColumns");this.renderCss(".karma-no-gutters > #"+elementId+"> .karma-column","padding-left",padding);this.el.querySelector(".karma-left-spacing").style.width=padding},extraclass:function(){var elementClass=this.model.get("shortcode_name").replace("_","-")+"-"+this.model.attributes.shortcode_attributes.element_key,defaultClasses=elementClass+" karma-column  "+this.model.attributes.shortcode_attributes.extraclass;this.el.firstElementChild.setAttribute("class",defaultClasses)},liveChangeGrid:function(){var that=this,key=this.model.get("element_key"),allColumnInSection=$(this.el.closest(".karma-row")).find('.karma-builder-element[data-name="karma_column"]');var changeGridOptions={selector:'.karma-builder-element[data-element-key="'+key+'"]',snapToGrid:true,gridPrefix:"karma-col-md",onStart:function(){KarmaView.removeActiveElement();allColumnInSection.addClass("karma-resizing-padding")},onStop:function(result){var newGrid=result.grid,nextSibilingColumn=that.$el.next('.karma-builder-element[data-name="karma_column"]');allColumnInSection.removeClass("karma-resizing-padding");that.newGrid(newGrid);that.$el.trigger("karma/finish/modifyColumns");if(nextSibilingColumn.length){var columnInstance=nextSibilingColumn.backboneView();columnInstance.$el.trigger("karma/finish/modifyColumns")}}};gridResizer(changeGridOptions)},newGrid:function(newGrid){var newLayout=this.$el.parent().backboneView().currentGrid();newLayout[newGrid.currentColumnIndex]=newGrid.currentColumnWidth;newLayout[newGrid.nextColumnIndex]=newGrid.nextColumnWidth;this.$el.parent().backboneView().changeRowLayout(newLayout)},changeColumnClassName:function(gridType,newCol){var regex=new RegExp("(?:^|\\s)karma-col-"+gridType+"-(.*?)(?!\\S)"),childCol=this.el.querySelector(".karma-column");this.el.className=this.el.className.replace(regex," karma-col-"+gridType+"-"+newCol);childCol.className=childCol.className.replace(regex," karma-col-"+gridType+"-"+newCol)},lg_size:function(){var newCol=this.model.attributes.shortcode_attributes.lg_size;this.changeColumnClassName("lg",newCol)},md_size:function(){var newCol=this.model.attributes.shortcode_attributes.md_size;this.changeColumnClassName("md",newCol)},xl_size:function(){var newCol=this.model.attributes.shortcode_attributes.xl_size;this.changeColumnClassName("xl",newCol)},sm_size:function(){var newCol=this.model.attributes.shortcode_attributes.sm_size;this.changeColumnClassName("sm",newCol)},updateWidthColumn:function(value){var newAttributes={sm_size:value,lg_size:value,md_size:value,xl_size:value};this.setAttributes(newAttributes,false)},deleteColumn:function(lastColumnKey){var columnKey=this.model.get("element_key"),models=karmaBuilder.karmaModels.where({parent_key:columnKey}),lastColChild=karmaBuilder.karmaModels.where({parent_key:lastColumnKey}),newOrder=1,that=this;if(lastColChild.length){newOrder=lastColChild[Object.keys(lastColChild)[Object.keys(lastColChild).length-1]].attributes.order+1}_.each(models,function(model){model.set({parent_key:lastColumnKey,order:newOrder},{silent:true});that.moveContent(lastColumnKey,model);newOrder++});this.el.innerHTML="";this.model.destroy()},moveContent:function(lastColumnKey,model){var viewObject=$('[data-element-key="'+model.get("element_key")+'"]').backboneView(),elementID=model.get("shortcode_name").replace("_","-")+"-"+model.get("element_key"),moveToColumn=$('[data-element-key="'+lastColumnKey+'"]').find(".karma-column-margin"),columnPlaceholder=moveToColumn.find(".karma-column-placeholder"),script=$("#script-"+elementID).clone(),style=$("#style-"+elementID).clone();this.removeExtraAssets(elementID);if(columnPlaceholder.length){columnPlaceholder.remove()}moveToColumn.append(viewObject.$el);moveToColumn.append(script);moveToColumn.append(style)},visibleontablet:function(){var tabletVisible=this.getAttributes(["visibleontablet"]).visibleontablet;if("on"==tabletVisible){this.el.querySelector(".karma-column").classList.remove("karma-deactive-on-tablet")}else{this.el.querySelector(".karma-column").classList.add("karma-deactive-on-tablet")}},visibleonmobile:function(){var mobileVisible=this.model.attributes.shortcode_attributes.visibleonmobile;if("on"==mobileVisible){this.el.querySelector(".karma-column").classList.remove("karma-deactive-on-mobile")}else{this.el.querySelector(".karma-column").classList.add("karma-deactive-on-mobile")}}})})(jQuery,karmaBuilder);