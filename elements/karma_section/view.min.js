(function($,karmaBuilder){karmaBuilder.section=karmaBuilder.shortcodes.extend({events:{click:"showBorder","mousedown .section-spacing":"showMouseToolTip","mousedown .row-top-spacing-dot-container":"showMouseToolTip","mousedown .row-bottom-spacing-dot-container":"showMouseToolTip"},initialize:function(options){karmaBuilder.section.__super__.initialize.apply(this,arguments);this.liveSpacing()},showSettingPanel:function(){this.model.attributes.shortcode_attributes["add_grid"]=this.currentGrid();karmaBuilder.section.__super__.showSettingPanel.apply(this,arguments)},showBorder:function(){$(".karma-active-section").removeClass("karma-active-section");this.$el.addClass("karma-active-section")},getColumnsId:function(){var columns=[];_.each(this.findChildren(),function(column){columns.push(column.attributes.shortcode_id)});return columns},updateWidthColumn:function(attributes,value){attributes["lg_size"]=value;attributes["md_size"]=value;attributes["sm_size"]=value;attributes["xl_size"]=value;return attributes},updateColumnModel:function(columnId,parentId,newWidth){var model=karmaBuilder.karmaModels.findWhere({parent_id:parentId,shortcode_id:columnId}),attributes;attributes=model.attributes.shortcode_attributes;attributes=this.updateWidthColumn(attributes,newWidth);model.set({shortcode_attributes:attributes},{silent:true})},deleteColumnModel:function(columnId,lastColumnId){var models=karmaBuilder.karmaModels.where({parent_id:columnId});_.each(models,function(model){model.set({parent_id:lastColumnId},{silent:true})});var columnModel=karmaBuilder.karmaModels.findWhere({shortcode_id:columnId});karmaBuilder.karmaModels.remove(columnModel)},getSum:function(total,num){return total+num},validateColumnLayout:function(grid){if(12==grid.reduce(this.getSum)){return true}return false},changeRowLayout:function(newLayout){if(false===this.validateColumnLayout(newLayout)){return false}var currentGrid=this.currentGrid(),parentId=this.model.attributes.shortcode_id,lastColumn,columns=this.getColumnsId();for(var counter in currentGrid){if(newLayout[counter]){this.updateColumnModel(columns[counter],parentId,newLayout[counter]);lastColumn=counter}else{this.deleteColumnModel(columns[counter],columns[lastColumn])}}if(newLayout.length>currentGrid.length){this.modifyColumns(counter,newLayout,columns[counter])}this.model.trigger("change",this.model);return true},modifyColumns:function(counter,newLayout,columnId){counter=parseInt(counter)+1;for(counter;counter<newLayout.length;counter++){var model=karmaBuilder.karmaModels.findWhere({shortcode_id:columnId}),attributes=model.attributes;attributes.shortcode_attributes=this.updateWidthColumn(attributes.shortcode_attributes,newLayout[counter]);attributes.shortcode_attributes["element_key"]=this.createNewElementKey();attributes["shortcode_id"]=attributes["shortcode_id"]+1;attributes["order"]=attributes["order"]+1;karmaBuilder.karmaModels.add(attributes)}},currentGrid:function(){var childrenModels=this.findChildren();var currentGrid=[];for(var i=0,len=childrenModels.length;i<len;i++){currentGrid.push(parseInt(childrenModels[i].attributes.shortcode_attributes.sm_size))}return currentGrid},calculateNewGrid:function(){var newGrid=this.currentGrid();newGrid.reverse();for(var i=0,len=newGrid.length;i<len;i++){if(newGrid[i]>1){newGrid[i]=parseInt(newGrid[i]-1);break}}newGrid.reverse();newGrid.push(1);return newGrid},showMouseToolTip:function(e){var tooltipDiv=document.body.querySelector(".tooltip-div");tooltipDiv.style.display="block";e.target.classList.add("target-moving");document.documentElement.addEventListener("mousemove",this.moveMouseToolTip,false);document.documentElement.addEventListener("mouseup",this.removeMouseToolTip,false)},moveMouseToolTip:function(e){var tooltipDiv=document.body.querySelector(".tooltip-div");if("none"===tooltipDiv.style.display){return false}var x=e.clientX,y=e.clientY;tooltipDiv.style.top=y+20+"px";tooltipDiv.style.left=x-20+"px";tooltipDiv.innerText=document.querySelector(".section-spacing").offsetHeight+" px"},removeMouseToolTip:function(e){var tooltipDiv=document.body.querySelector(".tooltip-div");tooltipDiv.style.display="none";e.target.classList.remove("target-moving");document.documentElement.removeEventListener("mousemove",this.moveMouseToolTip);document.documentElement.removeEventListener("mouseup",this.removeMouseToolTip)},toolTipHtml:function(){if(!document.querySelectorAll(".tooltip-div").length){var tooltip=document.createElement("div");tooltip.setAttribute("class","tooltip-div");document.body.appendChild(tooltip)}},liveSpacing:function(){this.currentGrid();this.calculateNewGrid();this.toolTipHtml();var that=this,options={maxHeight:700,minHeight:0,handles:{},stop:function(event,ui){that.setAttributes({space:parseInt(ui.element.height())},true)}};$(function(){options.handles.s=document.querySelector('[data-element-key="'+that.el.dataset.elementKey+'"] .section-top-spacing');options.handles.n=document.querySelector('[data-element-key="'+that.el.dataset.elementKey+'"] .section-top-spacing');options.alsoResize='[data-element-key="'+that.el.dataset.elementKey+'"] .section-bottom-spacing';$('[data-element-key="'+that.el.dataset.elementKey+'"] .section-top-spacing').resizable(options);options.alsoResize='[data-element-key="'+that.el.dataset.elementKey+'"] .section-top-spacing';options.handles.s=document.querySelector('[data-element-key="'+that.el.dataset.elementKey+'"] .section-bottom-spacing');options.handles.n=document.querySelector('[data-element-key="'+that.el.dataset.elementKey+'"] .section-bottom-spacing');$('[data-element-key="'+that.el.dataset.elementKey+'"] .section-bottom-spacing').resizable(options)})}})})(jQuery,karmaBuilder);