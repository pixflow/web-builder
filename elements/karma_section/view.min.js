(function($,karmaBuilder){karmaBuilder.section=karmaBuilder.shortcodes.extend({events:{click:"showBorder"},initialize:function(options){karmaBuilder.section.__super__.initialize.apply(this,arguments)},showSettingPanel:function(){this.model.attributes.shortcode_attributes["add_grid"]=this.currentGrid();karmaBuilder.section.__super__.showSettingPanel.apply(this,arguments)},showBorder:function(e){if(this.$el.hasClass("karma-active-section")&&$(e.target).closest(".karma-builder-element").hasClass("karma-active-column")){return}$(".karma-active-section .karma-active-column").removeClass("karma-active-column");$(".karma-active-section").removeClass("karma-active-section");this.$el.addClass("karma-active-section")},getColumnsKey:function(){var columns=[];_.each(this.findChildren(),function(column){columns.push(column.attributes.element_key)});return columns},currentGrid:function(){var childrenModels=this.findChildren();var currentGrid=[];for(var i=0,len=childrenModels.length;i<len;i++){currentGrid.push(parseInt(childrenModels[i].attributes.shortcode_attributes.sm_size))}return currentGrid},calculateNewGrid:function(){var newGrid=this.currentGrid();newGrid.reverse();for(var i=0,len=newGrid.length;i<len;i++){if(newGrid[i]>1){newGrid[i]=parseInt(newGrid[i]-1);break}}newGrid.reverse();newGrid.push(1);return newGrid},deleteColumnModel:function(columnKey,lastColumnKey){var model=karmaBuilder.karmaModels.findWhere({element_key:columnKey}),columnInstance=$('[data-element-key="'+model.attributes.element_key+'"]').backboneView();columnInstance.deleteColumn(lastColumnKey)},getSum:function(total,num){return total+num},validateColumnLayout:function(grid){if(12==grid.reduce(this.getSum)){return true}return false},updateColumnModel:function(columnKey,parentId,newWidth){var model=karmaBuilder.karmaModels.findWhere({element_key:columnKey}),columnInstance=$('[data-element-key="'+model.attributes.element_key+'"]').backboneView();columnInstance.updateWidthColumn(newWidth)},changeRowLayout:function(newLayout){if(false===this.validateColumnLayout(newLayout)){return false}var currentGrid=this.currentGrid(),parentKey=this.model.attributes.element_key,lastColumn,columns=this.getColumnsKey();for(var counter in currentGrid){if(newLayout[counter]){this.updateColumnModel(columns[counter],parentKey,newLayout[counter]);lastColumn=counter}else{this.deleteColumnModel(columns[counter],columns[lastColumn])}}if(newLayout.length>currentGrid.length){this.createNewColumn(counter,newLayout,columns[counter])}$(document).trigger("changeRowLayout/finished");return true},createNewColumn:function(counter,newLayout,columnKey){counter=parseInt(counter)+1;for(counter;counter<newLayout.length;counter++){var model=karmaBuilder.karmaModels.findWhere({element_key:columnKey}).attributes,newModel={element_key:this.createNewElementKey(),parent_key:model.parent_key,order:model.order+1,shortcode_content:"",shortcode_name:model.shortcode_name,shortcode_attributes:JSON.parse(JSON.stringify(model.shortcode_attributes))};newModel.shortcode_attributes.lg_size=newLayout[counter];newModel.shortcode_attributes.sm_size=newLayout[counter];newModel.shortcode_attributes.xl_size=newLayout[counter];newModel.shortcode_attributes.md_size=newLayout[counter];var CID=karmaBuilder.karmaModels.add(newModel).cid;this.createNewElement("column",karmaBuilder.karmaModels.get({cid:CID}))}},toolTipHtml:function(){if(!document.querySelectorAll(".tooltip-div").length){var tooltip=document.createElement("div");tooltip.setAttribute("class","tooltip-div");document.body.appendChild(tooltip)}},structure:function(){var defaultClasses="karma-row karma-no-gutters ",containerClass="container"==this.model.attributes.shortcode_attributes.structure?"karma-container":"karma-container-fluid",newStructure=defaultClasses+containerClass;this.el.firstElementChild.firstElementChild.setAttribute("class",newStructure)},space:function(){var elementId=this.el.getAttribute("data-name").replace("_","-")+"-"+this.el.getAttribute("data-element-key"),padding=this.model.attributes.shortcode_attributes.space+"px";this.$el.find(".karma-bottom-spacing").css("height",padding);this.renderCss("."+elementId,"padding-top",padding);this.renderCss("."+elementId,"padding-bottom",padding)},extraClass:function(){var elementClass=this.model.get("shortcode_name").replace("_","-")+"-"+this.model.attributes.shortcode_attributes.element_key,defaultClasses=elementClass+" karma-section  "+this.model.attributes.shortcode_attributes.extraClass;this.el.firstElementChild.setAttribute("class",defaultClasses)}})})(jQuery,karmaBuilder);