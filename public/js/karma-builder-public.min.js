var karmaBuilder=karmaBuilder||{};(function($,karmaBuilder){"use strict";karmaBuilder.view=Backbone.View.extend({events:{},initialize:function(){this.render()},render:function(){this.collection.each(function(element){var elementName=element.attributes.shortcode_name.replace("karma_","");var elementView=new karmaBuilder[elementName]({model:element,el:$("."+element.attributes.shortcode_name+"_"+element.attributes.shortcode_attributes.element_key)});elementView.createGizmo()})},prepareAjax:function(){return $.ajax({type:"post",url:ajaxurl,action:"save_content",data:{models:JSON.stringify(karmaBuilder.karmaModels),id:$('meta[name="post-id"]').attr("content")}})},saveContent:function(){this.prepareAjax().done(function(response){var result=JSON.parse(response);if(true===result.result){return true}else{return false}})},dragElement:function(){},dropElement:function(droppedElement,placeHolder){var shortcodeName=droppedElement.getAttribute("data-name");var shortcodeId=karmaBuilder.karmaModels.length+1;var newModel=new karmaBuilder.model({shortcode_id:shortcodeId,shortcode_name:shortcodeName});var newElement=new karmaBuilder.shortcodes({template:wp.template(shortcodeName),model:newModel});newElement.create(placeHolder)}});karmaBuilder.shortcodes=Backbone.View.extend({shortcodeParams:{},initialize:function(options){this.template=options.template},events:{"click .delete-element":"deleteShortcode"},createRandomString:function(length){var characters="0123456789abcdefghijklmnopqrstuvwxyz",charactersLength=characters.length,randomString="";for(var i=0;i<length;i++){randomString+=characters[Math.floor(Math.random()*(charactersLength-1)+1)]}return randomString},getElementMap:function(shortcodeName){if(this.shortcodeParams){this.shortcodeParams=JSON.parse(builderMaps)}return this.shortcodeParams[shortcodeName]},getWpTemplate:function(templateName,templateParams){if(null===templateParams){templateParams={}}var tempObject=wp.template(templateName),tempHtml=tempObject(templateParams);return tempHtml},createNewElementKey:function(){var randomString=this.createRandomString(6);if(karmaBuilder.karmaModels.where({element_key:randomString}).length){return this.createNewElementKey()}return randomString},create:function(placeHolder){var randomString=this.createNewElementKey();this.model.attributes.shortcode_attributes["element_key"]=randomString;karmaBuilder.karmaModels.add(this.model);this.render(placeHolder);return karmaBuilder.karmaModels},update:function(element){var children;if($(element).children().length){children=$(element).children().clone(true)}this.el.innerHTML=this.template(this.model);var elementId=$(element).attr("data-element-id");$(this.el).find('*[data-element-id="'+elementId+'"]').append(children);$("body").trigger("finish_update_html",[this.model]);return true},render:function(placeHolder){this.el.innerHTML=this.template(this.model);placeHolder.appendChild(this.el);$("body").trigger("karma_finish_render_html",[this.model]);return true},deleteShortcode:function(){var elementId=this.model.attributes["shortcode_id"];var $selectedElement=$(".karma-builder-element [data-element-id="+elementId+"]");$selectedElement.find(".karma-builder-element").each(function(){var childId=$(this).attr("data-element-id");karmaBuilder.karmaModels.remove(karmaBuilder.karmaModels.where({shortcode_id:parseInt(childId)}))});$selectedElement.remove();karmaBuilder.karmaModels.remove(this.model);return karmaBuilder.karmaModels},setAttributes:function(newAttributes,silent){var model=this.model,shortcodeAtrributes=model.attributes.shortcode_attributes;for(var attr in newAttributes){shortcodeAtrributes[attr]=newAttributes[attr]}model.set({shortcode_attributes:shortcodeAtrributes},{silent:silent})},updateShortcode:function(newAttributes){this.setAttributes(newAttributes,false);this.update(document.querySelector('*[data-element-id="'+model.attributes.shortcode_id+'"]'));return karmaBuilder.karmaModels},findChildren:function(){return karmaBuilder.karmaModels.where({parent_id:this.model.attributes["shortcode_id"]})}});karmaBuilder.elementSettingPanel=karmaBuilder.shortcodes.extend({initialize:function(options){this.options=options;karmaBuilder.elementSettingPanel.__super__.initialize.apply(this,arguments);this.render()},render:function(){this.openSettingPanel(this.options.shortcodeId);this.bindDragEvents()},events:{"click .close-svg":"removeSettingPanel"},bindDragEvents:function(){$("#karma-element-setting-panel-container").draggable({containment:"body",scroll:true,scrollSpeed:100,cancel:".karma-shortcode-setting-panel-extra , input"})},openSettingPanel:function(shortcodeId){var template=wp.template("karma-element-setting-panel");var $html=document.createElement("div");var content=this.formBuilder(shortcodeId);$html.innerHTML=template({headerTitle:"Section Setting",content:content});document.getElementById("page").appendChild($html);this.bindDragEvents();$("body").trigger("karma_finish_form_builder")},formBuilder:function(shortcodeId){var shortcodeModel=karmaBuilder.karmaModels.where({shortcode_id:shortcodeId})[0].attributes,ShortcodeParams=this.getElementMap(shortcodeModel.shortcode_name),karmaformhtml='<form id="karma-Builder-form" autocomplete="off" onsubmit="return false">',groupHtml="",groupHtml_group=[],setting_panel_group="";for(var counter in ShortcodeParams.params){if(!ShortcodeParams.params[counter].group){groupHtml+=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",ShortcodeParams.params[counter])}else{if(undefined===groupHtml_group[ShortcodeParams.params[counter].group]){groupHtml_group[ShortcodeParams.params[counter].group]={items:[],title:ShortcodeParams.params[counter].group}}var html=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",ShortcodeParams.params[counter]);groupHtml_group[ShortcodeParams.params[counter].group]["items"].push(html)}}for(var counter in groupHtml_group){setting_panel_group+=this.getWpTemplate("karma-setting-panel-groups-extend",groupHtml_group[counter])}karmaformhtml+='<div id="elementRow" >'+groupHtml+"</div>";var popup=document.createElement("div");popup.innerHTML=karmaformhtml+setting_panel_group;return popup.innerHTML},removeSettingPanel:function(){var settingPanel=document.querySelector("#karma-element-setting-panel-container");settingPanel.parentNode.removeChild(settingPanel)}});karmaBuilder.row=karmaBuilder.shortcodes.extend({gizmoTemplate:_.template('<div class="row-gizmo-button row-gizmo-background" ></div>'+'<div class="row-gizmo-button row-gizmo-layout" ></div>'+'<div class="row-gizmo-button row-gizmo-setting" ></div>'),initialize:function(){karmaBuilder.row.__super__.initialize.apply(this,arguments);this.liveSpacing()},events:{click:"showBorder"},createGizmo:function(){if(!this.el){return}var gizmoContainer=document.createElement("div");gizmoContainer.setAttribute("class","row-gizmo-group");gizmoContainer.innerHTML=this.gizmoTemplate();this.el.insertBefore(gizmoContainer,this.el.firstChild)},showBorder:function(){$(".karma-active-row").removeClass("karma-active-row");this.$el.addClass("karma-active-row")},currentGrid:function(){var childrenModels=this.findChildren();var currentGrid=[];for(var i=0,len=childrenModels.length;i<len;i++){currentGrid.push(parseInt(childrenModels[i].attributes.shortcode_attributes.width))}return currentGrid},calculateNewGrid:function(){var newGrid=this.currentGrid();newGrid.reverse();for(var i=0,len=newGrid.length;i<len;i++){if(newGrid[i]>1){newGrid[i]=parseInt(newGrid[i]-1);break}}newGrid.reverse();newGrid.push(1);return newGrid},liveSpacing:function(){this.el.insertAdjacentHTML("beforebegin",'<div class="section-spacing section-top-spacing"></div>');this.el.insertAdjacentHTML("afterend",'<div class="section-spacing section-bottom-spacing"></div>');var that=this,options={selector:".section-spacing",minHeight:0,maxHeight:700,direction:"y",onDrag:function(el,value){var siblingSpacer=Array.prototype.filter.call(el.parentNode.children,function(child){return child!==el&&child.classList.contains("section-spacing")});siblingSpacer[0].style.height=value.height},onStop:function(value){that.setAttributes({space:parseInt(value.height)},true)}};gridResizer(options)}});karmaBuilder.column=karmaBuilder.shortcodes.extend({initialize:function(){karmaBuilder.column.__super__.initialize.apply(this,arguments)},createGizmo:function(){}});karmaBuilder.model=Backbone.Model.extend({defaults:{shortcode_name:"karma_row",shortcode_attributes:{element_key:"",padding:"200"},shortcode_content:"",shortcode_id:1,order:1,parent_id:0}});var KarmaShortcodesCollection=Backbone.Collection.extend({model:karmaBuilder.model});$(document).ready(function(){karmaBuilder.karmaModels=new KarmaShortcodesCollection(JSON.parse(builderModels));var KarmaView=new karmaBuilder.view({collection:karmaBuilder.karmaModels})})})(jQuery,karmaBuilder);