var karmaBuilder=karmaBuilder||{};(function($,karmaBuilder){"use strict";karmaBuilder.view=Backbone.View.extend({gizmoParams:{},events:{},initialize:function(){this.gizmoParams=JSON.parse(builderGizmo);this.render()},render:function(){var that=this;this.collection.each(function(element){var elementName=element.attributes.shortcode_name.replace("karma_","");var elementView=new karmaBuilder[elementName]({model:element,el:$('[data-element-key="'+element.attributes.shortcode_attributes.element_key+'"]'),gimzoParams:that.gizmoParams[element.attributes.shortcode_name],template:wp.template("karma-element-"+element.attributes.shortcode_name)});elementView.createGizmo()})},prepareAjax:function(){return $.ajax({type:"post",url:ajaxurl,action:"save_content",data:{models:JSON.stringify(karmaBuilder.karmaModels),id:$('meta[name="post-id"]').attr("content")}})},saveContent:function(){this.prepareAjax().done(function(response){var result=JSON.parse(response);if(true===result.result){return true}else{return false}})},dragElement:function(){},dropElement:function(droppedElement,placeHolder){}});karmaBuilder.shortcodes=Backbone.View.extend({shortcodeParams:{},templateSettings:{evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"},innerGizmoTemplate:'<div class="{{ data.className }}">'+" <# _.each( data.params, function( param ){ #>"+' <div class="karma-builder-gizmo-{{ param.type }}">'+' <# if( "icon" === param.type ){ #>'+" <div>{{{ param.icon }}}</div>"+'<# } else if( "text" === param.type ) {#>'+"<div>{{{ param.value }}}</div>"+"<# } #>"+"</div>"+"<# }) #>"+"</div>",initialize:function(options){this.template=options.template;_.bindAll(this,"render");if(this.model){this.model.bind("change",this.render)}},events:{"click .karma-element-setting":"openSettingPanel"},createRandomString:function(length){var characters="0123456789abcdefghijklmnopqrstuvwxyz",charactersLength=characters.length,randomString="";for(var i=0;i<length;i++){randomString+=characters[Math.floor(Math.random()*(charactersLength-1)+1)]}return randomString},getElementMap:function(elementName){if(this.shortcodeParams){this.shortcodeParams=JSON.parse(builderMaps)}return this.shortcodeParams[elementName]},getWpTemplate:function(templateName,templateParams){if(null===templateParams){templateParams={}}var tempObject=wp.template(templateName),tempHtml=tempObject(templateParams);return tempHtml},getUnderscoreTemplate:function(templateName,params){var compiled,that=this;compiled=_.template(templateName,that.templateSettings);return compiled(params)},gizmoBuilder:function(gizmoParams){switch(gizmoParams.type){case"inner-gizmo":return this.getUnderscoreTemplate(this.innerGizmoTemplate,gizmoParams);break;case"top-gizmo":break;case"over-gizmo":break;default:return false;break}},createNewElementKey:function(){var randomString=this.createRandomString(6);if(karmaBuilder.karmaModels.where({element_key:randomString}).length){return this.createNewElementKey()}return randomString},update:function(element){var children,elementId=$(element).attr("data-element-id");if($(element).children().length){children=$(element).children().clone(true)}this.el.innerHTML=this.template(this.model);$(this.el).find('*[data-element-id="'+elementId+'"]').append(children);$("body").trigger("finish_update_html",[this.model]);return true},render:function(){this.el.innerHTML=this.template(this.model);$("body").trigger("karma_finish_render_html",[this.model]);return true},deleteShortcode:function(elementId){var model=karmaBuilder.karmaModels.where({shortcode_id:elementId}),$selectedElement=$(".karma-builder-element[data-element-id="+elementId+"]");$selectedElement.find(".karma-builder-element").each(function(){var childId=$(this).attr("data-element-id");karmaBuilder.karmaModels.remove(karmaBuilder.karmaModels.where({shortcode_id:parseInt(childId)}))});$selectedElement.remove();karmaBuilder.karmaModels.remove(model);return karmaBuilder.karmaModels},setAttributes:function(newAttributes,silent){console.log(this.model);var model=this.model,shortcodeAtrributes=model.attributes.shortcode_attributes;for(var attr in newAttributes){shortcodeAtrributes[attr]=newAttributes[attr]}model.set({shortcode_attributes:shortcodeAtrributes},{silent:silent})},updateShortcode:function(newAttributes){this.setAttributes(newAttributes,false);this.update(document.querySelector('*[data-element-id="'+model.attributes.shortcode_id+'"]'));return karmaBuilder.karmaModels},findChildren:function(){return karmaBuilder.karmaModels.where({parent_id:this.model.attributes["shortcode_id"]})},openSettingPanel:function(){window.builder=new karmaBuilder.elementSettingPanel({el:jQuery("body"),shortcodeId:this.model.get("shortcode_id")});builder.delegateEvents()}});karmaBuilder.elementSettingPanel=karmaBuilder.shortcodes.extend({events:{"click .karma-setting-panel-close-svg":"removeSettingPanel","click .delete-karma-element":"removeElement"},initialize:function(options){this.options=options;karmaBuilder.elementSettingPanel.__super__.initialize.apply(this,arguments);this.render()},render:function(){this.openSettingPanel(this.options.shortcodeId);this.bindDragEvents()},bindDragEvents:function(){$("#karma-element-setting-panel-container").draggable({containment:"body",scroll:true,scrollSpeed:100,distance:10,cancel:".karma-shortcode-setting-panel-extra, input"})},removeElement:function(){if(!confirm("are you sure?"))return;this.deleteShortcode(this.options.shortcodeId);this.removeSettingPanel()},openSettingPanel:function(shortcodeId){var template=wp.template("karma-element-setting-panel"),$html=document.createElement("div"),content=this.formBuilder(shortcodeId),elementAttributes=karmaBuilder.karmaModels.where({shortcode_id:shortcodeId})[0].attributes,elementName=elementAttributes["shortcode_name"].replace("karma_",""),elementSelector="."+elementAttributes["shortcode_name"]+"_"+elementAttributes.shortcode_attributes["element_key"];$html.innerHTML=template({headerTitle:elementName+" Setting",content:content,selector:elementSelector});document.getElementById("page").appendChild($html);this.bindDragEvents();$("body").trigger("karma_finish_form_builder")},formBuilder:function(shortcodeId){var shortcodeModel=karmaBuilder.karmaModels.where({shortcode_id:shortcodeId})[0].attributes,ShortcodeParams=this.getElementMap(shortcodeModel.shortcode_name),karmaformhtml='<form id="karma-Builder-form"  autocomplete="off" onsubmit="return false">',groupHtml="",groupHtml_group=[],setting_panel_group="";ShortcodeParams=this.updateElementParams(shortcodeModel,ShortcodeParams);for(var counter in ShortcodeParams.params){if(!ShortcodeParams.params[counter].group){groupHtml+=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",ShortcodeParams.params[counter])}else{if(undefined===groupHtml_group[ShortcodeParams.params[counter].group]){groupHtml_group[ShortcodeParams.params[counter].group]={items:[],title:ShortcodeParams.params[counter].group}}var html=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",ShortcodeParams.params[counter]);groupHtml_group[ShortcodeParams.params[counter].group]["items"].push(html)}}for(var counter in groupHtml_group){setting_panel_group+=this.getWpTemplate("karma-setting-panel-groups-extend",groupHtml_group[counter])}karmaformhtml+='<div id="elementRow" >'+groupHtml+"</div>";var popup=document.createElement("div");popup.innerHTML=karmaformhtml+setting_panel_group;return popup.innerHTML},removeSettingPanel:function(){var settingPanel=document.querySelector("#karma-element-setting-panel-container");settingPanel.parentNode.removeChild(settingPanel)},updateElementParams:function(model,elementParam){for(var index in elementParam.params){var paramName=elementParam.params[index].name;elementParam.params[index].value=model.shortcode_attributes[paramName]}return elementParam}});karmaBuilder.row=karmaBuilder.shortcodes.extend({rowGimzoParams:{},events:{"click .karma-section":"showBorder","mousedown .section-spacing":"showMouseToolTip"},initialize:function(options){karmaBuilder.row.__super__.initialize.apply(this,arguments);this.rowGimzoParams=options.gimzoParams[0];this.liveSpacing()},createGizmo:function(){this.$el.append($(this.gizmoBuilder(this.rowGimzoParams)))},showBorder:function(){$(".karma-active-section").removeClass("karma-active-section");this.$el.addClass("karma-active-section")},currentGrid:function(){var childrenModels=this.findChildren();var currentGrid=[];for(var i=0,len=childrenModels.length;i<len;i++){currentGrid.push(parseInt(childrenModels[i].attributes.shortcode_attributes.width))}return currentGrid},calculateNewGrid:function(){var newGrid=this.currentGrid();newGrid.reverse();for(var i=0,len=newGrid.length;i<len;i++){if(newGrid[i]>1){newGrid[i]=parseInt(newGrid[i]-1);break}}newGrid.reverse();newGrid.push(1);return newGrid},showMouseToolTip:function(e){var tooltipDiv=document.body.querySelector(".tooltip-div");tooltipDiv.style.display="block";e.target.classList.add("target-moving");document.documentElement.addEventListener("mousemove",this.moveMouseToolTip,false);document.documentElement.addEventListener("mouseup",this.removeMouseToolTip,false)},moveMouseToolTip:function(e){var tooltipDiv=document.body.querySelector(".tooltip-div");if("none"===tooltipDiv.style.display){return false}var x=e.clientX,y=e.clientY;tooltipDiv.style.top=y+20+"px";tooltipDiv.style.left=x-20+"px";tooltipDiv.innerText=document.querySelector(".target-moving").offsetHeight+" px"},removeMouseToolTip:function(e){var tooltipDiv=document.body.querySelector(".tooltip-div");tooltipDiv.style.display="none";e.target.classList.remove("target-moving");document.documentElement.removeEventListener("mousemove",this.moveMouseToolTip);document.documentElement.removeEventListener("mouseup",this.removeMouseToolTip)},toolTipHtml:function(){if(!document.querySelectorAll(".tooltip-div").length){var tooltip=document.createElement("div");tooltip.setAttribute("class","tooltip-div");document.body.appendChild(tooltip)}},liveSpacing:function(){this.toolTipHtml();var topSpacing=document.createElement("div");topSpacing.setAttribute("class","section-spacing section-top-spacing");var bottomSpacing=document.createElement("div");bottomSpacing.setAttribute("class","section-spacing section-bottom-spacing");this.el.appendChild(bottomSpacing);this.el.insertBefore(topSpacing,this.el.childNodes[0]);var that=this,options={selector:'[data-element-key="'+this.el.dataset.elementKey+'"] .section-spacing',minHeight:0,maxHeight:700,direction:"y",onDrag:function(el,value){var siblingSpacer=Array.prototype.filter.call(el.parentNode.children,function(child){return child!==el&&child.classList.contains("section-spacing")});siblingSpacer[0].style.height=value.height},onStop:function(value){that.setAttributes({space:parseInt(value.height)},true)}};gridResizer(options)}});karmaBuilder.column=karmaBuilder.shortcodes.extend({initialize:function(){karmaBuilder.column.__super__.initialize.apply(this,arguments)},createGizmo:function(){}});karmaBuilder.model=Backbone.Model.extend({defaults:{shortcode_name:"karma_row",shortcode_attributes:{element_key:"",padding:"200"},shortcode_content:"",shortcode_id:1,order:1,parent_id:0}});var KarmaShortcodesCollection=Backbone.Collection.extend({model:karmaBuilder.model});$(document).ready(function(){karmaBuilder.karmaModels=new KarmaShortcodesCollection(JSON.parse(builderModels));var KarmaView=new karmaBuilder.view({collection:karmaBuilder.karmaModels})})})(jQuery,karmaBuilder);