var karmaBuilder=karmaBuilder||{};(function($,karmaBuilder){"use strict";karmaBuilder.view=Backbone.View.extend({events:{},initialize:function(){var pageModel=JSON.parse(builderModels);karmaBuilder.karmaModels.add(pageModel)},prepareAjax:function(){return $.ajax({type:"post",url:ajaxurl,action:"save_content",data:{models:JSON.stringify(karmaBuilder.karmaModels),id:$('meta[name="post-id"]').attr("content")}})},saveContent:function(){this.prepareAjax().done(function(response){var result=JSON.parse(response);if(true===result.result){return true}else{return false}})},dragElement:function(){},dropElement:function(droppedElement,placeHolder){var shortcodeName=droppedElement.getAttribute("data-name");var shortcodeId=karmaBuilder.karmaModels.length+1;var newModel=new karmaBuilder.model({shortcode_id:shortcodeId,shortcode_name:shortcodeName});var newElement=new karmaBuilder.shortcodes({template:wp.template(shortcodeName),model:newModel});newElement.create(placeHolder)}});karmaBuilder.model=Backbone.Model.extend({defaults:{shortcode_id:0,shortcode_name:"",parent_id:0,order:1,shortcode_attributes:{},shortcode_content:""}});karmaBuilder.shortcodes=Backbone.View.extend({shortcodeParams:{},initialize:function(options){this.template=options.template},events:{"click .delete-element":"deleteShortcode"},createRandomString:function(length){var characters="0123456789abcdefghijklmnopqrstuvwxyz",charactersLength=characters.length,randomString="";for(var i=0;i<length;i++){randomString+=characters[Math.floor(Math.random()*(charactersLength-1)+1)]}return randomString},getElementMap:function(shortcodeName){if(this.shortcodeParams){this.shortcodeParams=JSON.parse(builderMaps)}return this.shortcodeParams[shortcodeName]},getWpTemplate:function(templateName,templateParams){if(null===templateParams){templateParams={}}var tempObject=wp.template(templateName),tempHtml=tempObject(templateParams);return tempHtml},createNewElementKey:function(){var randomString=this.createRandomString(6);if(karmaBuilder.karmaModels.where({element_key:randomString}).length){return this.createNewElementKey()}return randomString},create:function(placeHolder){var randomString=this.createNewElementKey();this.model.set({element_key:randomString},{silent:true});karmaBuilder.karmaModels.add(this.model);this.render(placeHolder);return karmaBuilder.karmaModels},update:function(element){var children;if($(element).children().length){children=$(element).children().clone(true)}this.el.innerHTML=this.template(this.model);var elementId=$(element).attr("data-element-id");$(this.el).find('*[data-element-id="'+elementId+'"]').append(children);$("body").trigger("finish_update_html",[this.model]);return true},render:function(placeHolder){this.el.innerHTML=this.template(this.model);placeHolder.appendChild(this.el);$("body").trigger("karma_finish_render_html",[this.model]);return true},deleteShortcode:function(){var elementId=this.model.attributes["shortcode_id"];var $selectedElement=$(".karma-builder-element [data-element-id="+elementId+"]");$selectedElement.find(".karma-builder-element").each(function(){var childId=$(this).attr("data-element-id");karmaBuilder.karmaModels.remove(karmaBuilder.karmaModels.where({shortcode_id:parseInt(childId)}))});$selectedElement.remove();karmaBuilder.karmaModels.remove(this.model);return karmaBuilder.karmaModels},updateShortcode:function(newAttributes){var model=this.model;var shortcodeAtrributes=model.attributes.shortcode_attributes;for(var attr in newAttributes){shortcodeAtrributes[attr]=newAttributes[attr]}model.set({shortcode_attributes:shortcodeAtrributes});this.update(document.querySelector('*[data-element-id="'+model.attributes.shortcode_id+'"]'));return karmaBuilder.karmaModels},findChildren:function(){return karmaBuilder.karmaModels.where({parent_id:this.model.attributes["shortcode_id"]})}});karmaBuilder.elementSettingPanel=karmaBuilder.shortcodes.extend({initialize:function(){karmaBuilder.elementSettingPanel.__super__.initialize.apply(this,arguments)},events:{"click .close-svg":"removeSettingPanel","click #karma-element-setting-panel-container":"draggableSettingPanel"},openSettingPanel:function(shortcodeId){var template=wp.template("karma-element-setting-panel");var $html=document.createElement("div");var content=this.formBuilder(shortcodeId);$html.innerHTML=template({headerTitle:"Section Setting",content:content});document.getElementById("page").appendChild($html);$("body").trigger("karma_finish_form_builder")},formBuilder:function(shortcodeId){var shortcodeModel=karmaBuilder.karmaModels.where({shortcode_id:shortcodeId})[0].attributes,ShortcodeParams=this.getElementMap(shortcodeModel.shortcode_name),karmaformhtml='<form id="karma-Builder-form" autocomplete="off" onsubmit="return false">',groupHtml="",groupHtml_group=[],setting_panel_group="";for(var counter in ShortcodeParams.params){if(!ShortcodeParams.params[counter].group){groupHtml+=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",ShortcodeParams.params[counter])}else{if(undefined===groupHtml_group[ShortcodeParams.params[counter].group]){groupHtml_group[ShortcodeParams.params[counter].group]={items:[],title:ShortcodeParams.params[counter].group}}var html=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",ShortcodeParams.params[counter]);groupHtml_group[ShortcodeParams.params[counter].group]["items"].push(html)}}for(var counter in groupHtml_group){setting_panel_group+=this.getWpTemplate("karma-setting-panel-groups-extend",groupHtml_group[counter])}karmaformhtml+='<div id="elementRow" >'+groupHtml+"</div>";var popup=document.createElement("div");popup.innerHTML=karmaformhtml+setting_panel_group;return popup.innerHTML},removeSettingPanel:function(){var settingPanel=document.querySelector("#karma-element-setting-panel-container");settingPanel.parentNode.removeChild(settingPanel)},draggableSettingPanel:function(){$("#karma-element-setting-panel-container").draggable({containment:"body",scroll:false,scrollSpeed:100,cancel:".karma-shortcode-setting-panel-extra"})}});karmaBuilder.sectionElement=karmaBuilder.shortcodes.extend({currentGrid:function(){var childrenModels=this.findChildren();var currentGrid=[];for(var i=0,len=childrenModels.length;i<len;i++){currentGrid.push(parseInt(childrenModels[i].attributes.shortcode_attributes.width))}return currentGrid},calculateNewGrid:function(){var newGrid=this.currentGrid();newGrid.reverse();for(var i=0,len=newGrid.length;i<len;i++){if(newGrid[i]>1){newGrid[i]=parseInt(newGrid[i]-1);break}}newGrid.reverse();newGrid.push(1);return newGrid}});var KarmaShortcodesCollection=Backbone.Collection.extend({model:karmaBuilder.model});karmaBuilder.karmaModels=new KarmaShortcodesCollection;window.onload=function(){new karmaBuilder.view({el:$("body")});window.builder=new karmaBuilder.elementSettingPanel({el:$("body")});builder.openSettingPanel(1);builder.delegateEvents()}})(jQuery,karmaBuilder);