var karmaBuilder=karmaBuilder||{};(function($,karmaBuilder){"use strict";karmaBuilder.view=Backbone.View.extend({shortcodeParams:{},initialize:function(){var pageModel=JSON.parse(builderModels);karmaBuilder.karmaModels.add(pageModel)},events:{},prepareAjax:function(){return $.ajax({type:"post",url:ajaxurl,action:"save_content",data:{models:JSON.stringify(karmaBuilder.karmaModels),id:$('meta[name="post-id"]').attr("content")}})},saveContent:function(){this.prepareAjax().done(function(response){var result=JSON.parse(response);if(true===result.result){return true}else{return false}})},dragElement:function(){},dropElement:function(droppedElement,placeHolder){var shortcodeName=droppedElement.getAttribute("data-name");var shortcodeId=karmaBuilder.karmaModels.length+1;var newModel=new karmaBuilder.model({shortcode_id:shortcodeId,shortcode_name:shortcodeName});var newElement=new karmaBuilder.shortcodes({template:wp.template(shortcodeName),model:newModel});newElement.create(placeHolder)},getElementMap:function(shortcodeName){if(this.shortcodeParams){this.shortcodeParams=JSON.parse(builderMaps)}return this.shortcodeParams[shortcodeName]},getWpTemplate:function(templateName,templateParams){if(null===templateParams){templateParams={}}var tempObject=wp.template(templateName),tempHtml=tempObject(templateParams);return tempHtml},formBuilder:function(shortcodeId){console.log(shortcodeId);var shortcodeModel=karmaBuilder.karmaModels.where({shortcode_id:shortcodeId})[0].attributes,ShortcodeParams=this.getElementMap(shortcodeModel.shortcode_name),karmaformhtml='<form id="karma-Builder-form" autocomplete="off">',groupHtml="";console.log(ShortcodeParams.params);for(var counter in ShortcodeParams.params){switch(ShortcodeParams.params[counter].type){case"text":groupHtml+=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",{labelHeading:ShortcodeParams.params[counter].label,name:ShortcodeParams.params[counter].name});break;case"title":groupHtml+=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",{title:ShortcodeParams.params[counter].label,name:ShortcodeParams.params[counter].name});break;case"radio-image":groupHtml+=this.getWpTemplate("karma-"+ShortcodeParams.params[counter].type+"-controller",{field:ShortcodeParams.params[counter].field,column:ShortcodeParams.params[counter].columns});break;default:break}}karmaformhtml+='<div id="elementRow" >'+groupHtml+"</div>";var popup=document.createElement("div");popup.innerHTML=karmaformhtml;return popup.innerHTML}});karmaBuilder.model=Backbone.Model.extend({defaults:{shortcode_id:0,shortcode_name:"",parent_id:0,order:1,shortcode_attributes:{},shortcode_content:""}});karmaBuilder.shortcodes=Backbone.View.extend({initialize:function(options){this.template=options.template},events:{"click .delete-element":"deleteShortcode"},create:function(placeHolder){karmaBuilder.karmaModels.add(this.model);this.render(placeHolder);return karmaBuilder.karmaModels},update:function(element){var children;if($(element).children().length){children=$(element).children().clone(true)}this.el.innerHTML=this.template(this.model);var elementId=$(element).attr("data-element-id");$(this.el).find('*[data-element-id="'+elementId+'"]').append(children);$("body").trigger("finish_update_html",[this.model]);return true},render:function(placeHolder){this.el.innerHTML=this.template(this.model);placeHolder.appendChild(this.el);$("body").trigger("finish_render_html",[this.model]);return true},deleteShortcode:function(){var elementId=this.model.attributes["shortcode_id"];var $selectedElement=$(".karma-builder-element [data-element-id="+elementId+"]");$selectedElement.find(".karma-builder-element").each(function(){var childId=$(this).attr("data-element-id");karmaBuilder.karmaModels.remove(karmaBuilder.karmaModels.where({shortcode_id:parseInt(childId)}))});$selectedElement.remove();karmaBuilder.karmaModels.remove(this.model);return karmaBuilder.karmaModels},updateShortcode:function(newAttributes){var model=this.model;var shortcodeAtrributes=model.attributes.shortcode_attributes;for(var attr in newAttributes){shortcodeAtrributes[attr]=newAttributes[attr]}model.set({shortcode_attributes:shortcodeAtrributes});this.update(document.querySelector('*[data-element-id="'+model.attributes.shortcode_id+'"]'));return karmaBuilder.karmaModels},findChildren:function(){return karmaBuilder.karmaModels.where({parent_id:this.model.attributes["shortcode_id"]})}});karmaBuilder.sectionElement=karmaBuilder.shortcodes.extend({currentGrid:function(){var childrenModels=this.findChildren();var currentGrid=[];for(var i=0,len=childrenModels.length;i<len;i++){currentGrid.push(parseInt(childrenModels[i].attributes.shortcode_attributes.width))}return currentGrid},calculateNewGrid:function(){var newGrid=this.currentGrid();newGrid.reverse();for(var i=0,len=newGrid.length;i<len;i++){if(newGrid[i]>1){newGrid[i]=parseInt(newGrid[i]-1);break}}newGrid.reverse();newGrid.push(1);return newGrid}});var KarmaShortcodesCollection=Backbone.Collection.extend({model:karmaBuilder.model});karmaBuilder.karmaModels=new KarmaShortcodesCollection;window.onload=function(){}})(jQuery,karmaBuilder);